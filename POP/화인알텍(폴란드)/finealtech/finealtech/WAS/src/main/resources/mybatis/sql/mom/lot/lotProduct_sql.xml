<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.lot.lotProduct">
	<select id="get_lotProduct_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT TO_CHAR(A.WORK_DATE, 'YYYY-MM-DD') WORK_DATE
		     , A.LINE_ID
		     , A.CAR_TYPE
		     , A.CAR_NAME
		     , A.ITEM_ID
		     , A.ITEM_NAME
		     , MIN(A.QTY)                AS QTY
		     , A.MATERIAL_ITEM_ID
		     , MAX(A.MATERIAL_LOT_ID1)   AS MATERIAL_LOT_ID1
		     , MAX(A.MATERIAL_LOT_ID2)   AS MATERIAL_LOT_ID2
		     , MAX(A.MATERIAL_LOT_ID3)   AS MATERIAL_LOT_ID3
		     , MIN(A.WORK_ORDER_ID)      AS WORK_ORDER_ID
		     , A.PRODUCT_LOT_ID
		     , TO_CHAR(MIN(A.START_TIME), 'YYYY-MM-DD')         AS START_TIME
		  FROM (SELECT B.WORK_DAY        AS WORK_DATE
		             , B.RESOURCE_CD     AS LINE_ID
		             , C.ITEM_GROUP_SMALL AS CAR_TYPE
		             , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(C.DIVISION_CD, C.COMPANY_CD, 'MATERIAL_GROUP_SMALL', C.ITEM_GROUP_SMALL) FROM DUAL) AS CAR_NAME
		             , A.ITEM_ID
		             , C.ITEM_NAME
		             , A.QTY
		             , E.ITEM_ID          AS MATERIAL_ITEM_ID
		             , DECODE(D.POSITION, 1, D.IN_BARCODE_ID, '') AS MATERIAL_LOT_ID1
		             , DECODE(D.POSITION, 2, D.IN_BARCODE_ID, '') AS MATERIAL_LOT_ID2
		             , DECODE(D.POSITION, 3, D.IN_BARCODE_ID, '') AS MATERIAL_LOT_ID3
		             , A.ITEM_ORDER_ID                            AS WORK_ORDER_ID
		             , A.BARCODE_ID                               AS PRODUCT_LOT_ID
		             , B.START_TIME
		             , A.DIVISION_CD
		             , A.COMPANY_CD
		          FROM MOM_ITEM_LABEL A
		             , MOM_WORK_ORDER_RESULT B
		             , MOM_ITEM_DEFINITION C
		             , MOM_ITEM_LABEL_REL D
		             , MOM_ITEM_LABEL     E
		         WHERE A.DIVISION_CD          = B.DIVISION_CD
		           AND A.COMPANY_CD           = B.COMPANY_CD
		           AND A.WORK_ORDER_RESULT_ID = B.WORK_ORDER_RESULT_ID
		           AND A.DIVISION_CD          = C.DIVISION_CD
		           AND A.COMPANY_CD           = C.COMPANY_CD
		           AND A.ITEM_ID              = C.ITEM_ID
		           AND A.DIVISION_CD          = D.DIVISION_CD
		           AND A.COMPANY_CD           = D.COMPANY_CD
		           AND A.BARCODE_ID           = D.OUT_BARCODE_ID
		           AND D.DIVISION_CD          = E.DIVISION_CD
		           AND A.COMPANY_CD           = E.COMPANY_CD
		           AND D.IN_BARCODE_ID        = E.BARCODE_ID
		           AND A.DIVISION_CD          = #{divisionCd, jdbcType=VARCHAR}
		           AND A.COMPANY_CD           = #{companyCd, jdbcType=VARCHAR}
		           AND A.BARCODE_TYPE         = 'PRD'
		          <if test="fromDate != null and fromDate != ''">
		           AND B.WORK_DAY BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
		          </if>
		          <if test="inResource != null and inResource != ''">
		           AND B.RESOURCE_CD = #{inResource, jdbcType=VARCHAR}
		          </if>
		          <if test="inItem != null and inItem != ''">
		           AND (UPPER(A.ITEM_ID) LIKE UPPER('%' || #{inItem, jdbcType=VARCHAR} || '%') 
		            OR UPPER(C.ITEM_NAME) LIKE UPPER('%' || #{inItem, jdbcType=VARCHAR} || '%'))
		          </if>
		          <if test="inMaterailLot != null and inMaterailLot != ''">
		           AND D.IN_BARCODE_ID LIKE UPPER('%' || #{inMaterailLot, jdbcType=VARCHAR} || '%')
		          </if>
		         ) A
		 GROUP BY A.WORK_DATE
		        , A.LINE_ID
		        , A.CAR_TYPE
		        , A.CAR_NAME
		        , A.ITEM_ID
		        , A.ITEM_NAME
		        , A.PRODUCT_LOT_ID
		        , A.MATERIAL_ITEM_ID
		 ORDER BY MAX(A.START_TIME),A.PRODUCT_LOT_ID 
	</select>
	
</mapper>