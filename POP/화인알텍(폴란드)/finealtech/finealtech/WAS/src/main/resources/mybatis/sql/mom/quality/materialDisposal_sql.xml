<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.quality.materialDisposal">
	<select id="get_materialDisposal_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT A.ITEM_ID
             , C.ITEM_NAME
             , C.SPECIFICATION
             , C.ITEM_TYPE
             , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME( A.DIVISION_CD, A.COMPANY_CD, 'ITEM_TYPE', C.ITEM_TYPE)  
                FROM   DUAL ) AS ITEM_TYPE_NAME
<!--              , MC.CODE_NAME ITEM_TYPE_NAME -->
             , B.VENDOR_NAME
             , D.FACILITY_NAME
             , A.LOCATION_CD
             , A.CURRENT_QTY
             , A.ITEM_STOCK_ID
             , A.TID
             , (A.CURRENT_QTY * C.CONVERSION_UNIT_QTY) AS CONVERSION_UNIT_QTY
             , NVL(C.CONVERSION_UNIT_QTY, 1) AS ORIGIN_CONVERSION_UNIT_QTY
             , '' AS DISCARD_QTY
             , '' AS DISCARD_DATE
             , '' AS REASON_CODE
             , A.DESCRIPTION
             , D.SCRAP_LOCATION_FLAG
          FROM MOM_ITEM_STOCK A
             , MOM_VENDOR B
             , MOM_ITEM_DEFINITION C
             , MOM_FACILITY D
<!--              , (SELECT CODE_ID -->
<!--                      , CODE_NAME -->
<!--                   FROM MOM_CODE -->
<!--                  WHERE CODE_CLASS_ID = 'ITEM_TYPE' -->
<!--                    AND DIVISION_CD = 'TUKR' -->
<!--                    AND COMPANY_CD = 'THIRAUTECH') MC -->
         WHERE A.CURRENT_QTY != 0
           AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
           AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
           AND A.DIVISION_CD = B.DIVISION_CD(+)
           AND A.COMPANY_CD = B.COMPANY_CD(+)
           AND A.DIVISION_CD = C.DIVISION_CD
           AND A.COMPANY_CD = C.COMPANY_CD
           AND A.DIVISION_CD = D.DIVISION_CD
           AND A.COMPANY_CD = D.COMPANY_CD
<!--            AND C.ITEM_TYPE = MC.CODE_ID(+) -->
           AND A.LOCATION_CD = B.VENDOR_CD(+)
           AND A.ITEM_ID = C.ITEM_ID
           AND A.LOCATION_CD = D.FACILITY_CD(+)
           AND NVL(D.SCRAP_LOCATION_FLAG, 'N') = 'Y'
           <if test = "itemName != null and itemName != ''">
           AND (UPPER(A.ITEM_ID) LIKE UPPER ('%' || #{itemName, jdbcType=VARCHAR} || '%')
           OR   UPPER(C.ITEM_NAME) LIKE UPPER ('%' || #{itemName, jdbcType=VARCHAR} || '%'))
           </if>
           <if test = "locationName != null and locationName != ''">
           AND A.LOCATION_CD = #{locationName, jdbcType=VARCHAR}
           </if>
           <if test = "itemType != null and itemType != ''">
           AND C.ITEM_TYPE = #{itemType, jdbcType=VARCHAR}
           </if>
         ORDER BY A.ITEM_ID, A.LOCATION_CD, A.UPDATE_DATE 
	</select>
	
	<delete id="remove_materialDisposal" parameterType="java.util.HashMap">
		DELETE FROM MOM_MATERIAL_SCRAP_TMP
		 WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	</delete>
	
	<insert id="create_materialDisposal" parameterType="java.util.HashMap">
		INSERT INTO MOM_MATERIAL_SCRAP_TMP
		(
			DIVISION_CD,	
			COMPANY_CD,	
			LOCATION_CD,	
			ITEM_ID,	
			SCRAP_QTY,	
			SCRAP_DATE,	
			SCRAP_CD,	
			DESCRIPTION,	
			MODIFIER,	
			SEQ,
			CONVERSION_UNIT_QTY
		)
		VALUES
		(
			#{divisionCd, jdbcType=VARCHAR},
			#{companyCd, jdbcType=VARCHAR},
			#{locationCd, jdbcType=VARCHAR},
			#{itemId, jdbcType=VARCHAR},
			#{discardQty, jdbcType=NUMERIC},
			TO_DATE(#{discardDate, jdbcType=VARCHAR}, 'YYYY-MM-DD'),
			#{reasonCode, jdbcType=VARCHAR},
			#{description, jdbcType=VARCHAR},
			#{userId, jdbcType=VARCHAR},
			#{seq, jdbcType=NUMERIC},
			#{conversionUnitQty, jdbcType=NUMERIC}
		)
	</insert>
	
	<insert id="create_materialDisposalProc" statementType="CALLABLE">
		{
	        CALL SP_MOM_MATERIAL_PKG.P_CREATE_MATERIAL_SCRAP (
	             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
	           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
	           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
	           , #{companyCd, mode=IN, jdbcType=VARCHAR}
	           , #{createBy, mode=IN, jdbcType=VARCHAR}
	        )
	    }
	</insert>
</mapper>