<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.close.monthlyClosing">
	<select id="get_monthlyCloseMstr_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT A.*
		     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR}, 'MAGAM_IO_FLAG', A.IO_TYPE) FROM DUAL) IO_TYPE_NAME
		FROM (SELECT A.VENDOR_CD
		           , A.IO_TYPE
		           , MAX(A.VENDOR_NAME) VENDOR_NAME
		           , MAX(A.BUSINESS_NO) BUSINESS_NO
		           , TRUNC(SUM(A.QTY * NVL(A.UNIT_PRICE,0))) MONTH_PRICE
		      FROM (SELECT A.DIVISION_CD
		                 , A.COMPANY_CD
		                 , A.IO_TYPE
		                 , A.IO_TIME
		                 , A.VENDOR_CD
		                 , A.MARKET_CD
		                 , A.IO_CATEGORY
		                 , A.UNIT_PRICE
		                 , A.QTY
		                 , A.LOCATION_CD
		                 , MV.VENDOR_NAME
		                 , MV.BUSINESS_NO
		              FROM MOM_ITEM_STOCK_INOUT A
		                 , MOM_VENDOR MV
		             WHERE A.VENDOR_CD = MV.VENDOR_CD
		               AND A.DIVISION_CD = MV.DIVISION_CD
		               AND A.VENDOR_CD = MV.VENDOR_CD
		            ) A
		      WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		        AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
 		        AND A.IO_TIME BETWEEN TO_DATE(#{closingMonth, jdbcType=VARCHAR}, 'YYYY-MM') AND LAST_DAY(TO_DATE(#{closingMonth, jdbcType=VARCHAR},'YYYY-MM')) 
		    
		        AND A.IO_CATEGORY IN (SELECT CODE_ID
		                                FROM MOM_CODE
		                               WHERE CODE_CLASS_ID = 'IO_CATEGORY'
		                                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		                                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		                                 AND ATTRIBUTE16 = #{psFlag, jdbcType=VARCHAR}
                                         AND USE_YN = 'Y' )
		      GROUP BY A.VENDOR_CD, A.IO_TYPE
		       ) A
		WHERE 1=1
		  AND A.IO_TYPE = #{psFlag, jdbcType=VARCHAR}
          <if test = "vendorName != '' and vendorName != null">
          AND A.VENDOR_CD = #{vendorName, jdbcType=VARCHAR}
          </if>
          <if test = "closingFlag != '' and closingFlag != null">
          AND A.CLOSING_FLAG = #{closingFlag, jdbcType=VARCHAR}
          </if>
		ORDER BY MONTH_PRICE DESC
	</select>
	
	<select id="get_monthlyCloseDtl_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT A.*
		     , (SELECT MOM_COMMON_PKG.FN_GET_VENDOR_NAME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR}, A.DESTINATION_ID) FROM DUAL) AS DESTINATION_NAME
		FROM
		(
		  SELECT A.VENDOR_CD
		       , (SELECT MOM_COMMON_PKG.FN_GET_VENDOR_NAME(A.DIVISION_CD, A.COMPANY_CD, A.VENDOR_CD) FROM DUAL) VENDOR_NAME
		       , A.IO_TYPE
		       , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.DIVISION_CD, A.COMPANY_CD, 'MAGAM_IO_FLAG', A.IO_TYPE) FROM DUAL) IO_TYPE_NAME
		       , A.ITEM_STOCK_INOUT_ID
		       , TO_CHAR(A.IO_TIME,'yyyy-mm-dd') IO_TIME
		       , A.LOCATION_CD
		       , (SELECT MOM_COMMON_PKG.FN_GET_FACILITY_NAME(A.DIVISION_CD, A.COMPANY_CD, A.LOCATION_CD) FROM DUAL) LOCATION_NAME
		       , A.IO_CATEGORY
		       , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.DIVISION_CD, A.COMPANY_CD,'IO_CATEGORY', A.IO_CATEGORY) FROM DUAL) IO_CATEGORY_NAME
		       , A.ITEM_ID
		       , MID.ITEM_NAME
		       , MID.SPECIFICATION
		       , A.QTY
		       , A.UNIT_PRICE
		       , A.INOUT_PRICE
		       , A.CURRENCY_CD
		       , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.DIVISION_CD, A.COMPANY_CD, 'CURRENCY_CODE', A.CURRENCY_CD) FROM DUAL) CURRENCY_NAME
		       , A.MARKET_CD
		       , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.DIVISION_CD, A.COMPANY_CD, 'MARKET_CODE', A.MARKET_CD) FROM DUAL) MARKET_NAME
		       , DECODE(MIL.MAGAM_DETAIL_SEQ, NULL, 'N' , 'Y') MAGAM_FLAG
		       , TO_CHAR(A.CREATE_DATE, 'yyyy-mm-dd hh24:mi:ss') CREATE_DATE
		       , CASE WHEN A.IO_TYPE = 'I' THEN
		                     ( SELECT NVL(DEPARTURE_VENDOR_CD,  VENDOR_CD )
		                       FROM   MOM_MATERIAL_ORDER
		                       WHERE  DIVISION_CD = A.DIVISION_CD
		                       AND    MATERIAL_ORDER_ID  = A.ITEM_ORDER_ID )
		              ELSE
		                     ( SELECT NVL(SO.DESTINATION_CD, SO.VENDOR_CD )
		                       FROM   MOM_SALES_ORDER SO
		                       WHERE  SO.DIVISION_CD = A.DIVISION_CD
		                       AND    SO.SALES_ORDER_ID = A.ITEM_ORDER_ID )
		              END DESTINATION_ID
		       , ( SELECT S.CUSTOMER_PO_ID
		             FROM MOM_SALES_ORDER S
		            WHERE S.DIVISION_CD = A.DIVISION_CD
		              AND S.SALES_ORDER_ID = A.ITEM_ORDER_ID) AS CUSTOMER_PO_ID
		  FROM MOM_ITEM_STOCK_INOUT A
		       , MOM_ITEM_DEFINITION MID
		       , MOM_ITEM_LAST MIL
		  WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		    AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		    AND A.VENDOR_CD IS NOT NULL
		    AND A.DIVISION_CD = MID.DIVISION_CD(+)
		    AND A.ITEM_ID = MID.ITEM_ID(+)
		    AND A.ITEM_STOCK_INOUT_ID = MIL.ITEM_STOCK_INOUT_ID(+)
		    AND A.DIVISION_CD = MIL.DIVISION_CD(+)
		    AND A.COMPANY_CD = MIL.COMPANY_CD(+)
		    AND A.IO_TYPE = #{psFlag, jdbcType=VARCHAR}
 		    AND A.VENDOR_CD IN ${vendorCd}
 		    AND TO_CHAR (A.IO_TIME, 'yyyy-mm') = #{closingMonth, jdbcType=VARCHAR} 
		    AND A.IO_CATEGORY IN (SELECT CODE_ID
								    FROM MOM_CODE
								   WHERE CODE_CLASS_ID = 'IO_CATEGORY'
								     AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
								     AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
                                     AND ATTRIBUTE16 = #{psFlag, jdbcType=VARCHAR}
								     AND USE_YN = 'Y' )
		)  A
		WHERE 1=1
		ORDER BY A.VENDOR_CD, A.IO_TYPE, A.IO_TIME, A.IO_CATEGORY, A.ITEM_ID
	</select>
	
	<insert id="create_monthlyVendorClose" statementType="CALLABLE">
	{
		CALL P_MONTHLY_VENDOR_CLOSE ( 
			 #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{vendorCd, mode=IN, jdbcType=VARCHAR}
           , #{yyyymm, mode=IN, jdbcType=VARCHAR}
           , #{ioType, mode=IN, jdbcType=VARCHAR}
           , #{magamAmount, mode=IN, jdbcType=NUMERIC}
           , #{createBy, mode=IN, jdbcType=VARCHAR}
           , #{description, mode=IN, jdbcType=VARCHAR}
		)
	}
	</insert>
	
	<insert id="create_itemInoutPriceUpdate" statementType="CALLABLE">
	{
		CALL P_ITEM_INOUT_PRICE_UPDATE ( 
			 #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{vendorCd, mode=IN, jdbcType=VARCHAR}
           , #{yyyymm, mode=IN, jdbcType=VARCHAR}
           , #{ioType, mode=IN, jdbcType=VARCHAR}
           , #{createBy, mode=IN, jdbcType=VARCHAR}
           , #{description, mode=IN, jdbcType=VARCHAR}
		)
	}
	</insert>
	
	
	<delete id="remove_itemPriceUpdateTmp" statementType="CALLABLE" parameterType="java.util.HashMap">
        DELETE FROM MOM_ITEM_PRICE_UPDATE_TMP
         WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
           AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
           AND INOUT_FLAG = #{inoutFlag, jdbcType=VARCHAR}
    </delete>
    
    <insert id="create_itemPriceUpdateTmp" statementType="CALLABLE" parameterType="java.util.HashMap">
        INSERT INTO MOM_ITEM_PRICE_UPDATE_TMP
		            ( DIVISION_CD 
		            , COMPANY_CD  
		            , VENDOR_CD   
		            , INOUT_FLAG  
		            , YYYY_MM     
		            , CREATE_DATE 
		            , CREATE_BY   
		            )
		VALUES      ( #{divisionCd, jdbcType=VARCHAR}
		            , #{companyCd, jdbcType=VARCHAR}
		            , #{vendorCd, jdbcType=VARCHAR}
		            , #{inoutFlag, jdbcType=VARCHAR}
		            , #{yyyyMm, jdbcType=VARCHAR}
		            , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR})
                    , #{createBy, jdbcType=VARCHAR}
		            )
    </insert>
	
</mapper>