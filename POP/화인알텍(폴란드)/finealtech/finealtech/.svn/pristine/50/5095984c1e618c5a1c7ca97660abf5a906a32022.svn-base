<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.workOrder.materialDeductHist">
	<select id="get_materialDeductHist_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT *FROM (SELECT  A.WORK_ORDER_ID                          
	            , (SELECT O.ITEM_ID
	               FROM   MOM_WORK_ORDER O
	               WHERE  O.DIVISION_CD = A.DIVISION_CD
	               AND    O.COMPANY_CD    = A.COMPANY_CD
	               AND    O.WORK_ORDER_ID = A.WORK_ORDER_ID ) PARENT_ITEM_ID 
	            , A.ITEM_ID             
	            , B.ITEM_NAME           
	            , B.SPECIFICATION   
	            , MO.RESOURCE_CD
                , (SELECT MOM_COMMON_PKG.FN_GET_RESOURCE_NAME (MO.DIVISION_CD, MO.COMPANY_CD, MO.RESOURCE_CD) FROM DUAL) AS RESOURCE_NAME      
	            , A.LOCATION_CD       
	            , (SELECT MOM_COMMON_PKG.FN_GET_FACILITY_NAME(A.DIVISION_CD, A.COMPANY_CD,A.LOCATION_CD)
	               FROM   DUAL)  AS LOCATION_NAME 
	            , TO_CHAR(A.IO_TIME, 'YYYY-MM-DD') AS IO_TIME     
	            , A.UNIT        
	            , A.QTY          
	            , A.CONVERSION_UNIT_QTY
	            , TO_CHAR(A.UPDATE_DATE, 'YYYY-MM-DD') AS UPDATE_DATE         
	            , A.UPDATE_BY          
	            , (SELECT MOM_COMMON_PKG.FN_GET_USER_NAME(A.DIVISION_CD, A.COMPANY_CD,A.UPDATE_BY)
	               FROM   DUAL)  AS UPDATE_NAME 
	            , A.ITEM_STOCK_INOUT_ID   
	            , TO_CHAR(MIC.IO_TIME, 'YYYY-MM-DD') AS CANCEL_TIME
	            , MIC.QTY                            AS CANCEL_QTY
	      FROM    MOM_ITEM_STOCK_INOUT A
	            , MOM_ITEM_DEFINITION B
	            , MOM_ITEM_STOCK_INOUT MIC
	            , MOM_WORK_ORDER MO
	      WHERE   A.DIVISION_CD = B.DIVISION_CD
	      AND     A.COMPANY_CD =  B.COMPANY_CD
	      AND     A.ITEM_ID    = B.ITEM_ID
	      AND     A.DIVISION_CD = MIC.DIVISION_CD(+)
	      AND     A.COMPANY_CD =  MIC.COMPANY_CD(+)
	      AND     A.ITEM_STOCK_INOUT_ID = MIC.PREV_STOCK_INOUT_ID(+)
	      AND     A.DIVISION_CD = MO.DIVISION_CD(+)
	      AND     A.COMPANY_CD =  MO.COMPANY_CD(+)
          AND     A.WORK_ORDER_ID = MO.WORK_ORDER_ID
	      AND     A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
	      AND     A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	      AND     A.IO_CATEGORY = 'MC001'
		<if test = "workOrder != null and workOrder != ''">
		  AND 	  A.WORK_ORDER_ID LIKE UPPER('%' || #{workOrder, jdbcType=VARCHAR} || '%')
		</if>
		<if test = "deductItem != null and deductItem != ''">
          AND 	 (A.ITEM_ID LIKE UPPER('%' || #{deductItem, jdbcType=VARCHAR} || '%')
           OR	  UPPER(B.ITEM_NAME) LIKE UPPER('%' || #{deductItem, jdbcType=VARCHAR} || '%'))
        </if>
        <if test = "location != null and location != ''">
          AND 	  A.LOCATION_CD = #{location, jdbcType=VARCHAR}
        </if>
        <if test = "resource != null and resource != ''">
		  AND 	  MO.RESOURCE_CD = #{resource, jdbcType=VARCHAR}
		</if>
		  AND     A.IO_TIME BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
		  ORDER BY A.WORK_ORDER_ID, A.ITEM_ID ) A
		  WHERE 1 = 1
		<if test = "workItem != null and workItem != ''">
		  AND 	  A.PARENT_ITEM_ID LIKE UPPER('%' || #{workItem, jdbcType=VARCHAR} || '%')
		</if>
	</select>
	
	<insert id="create_materialDeductCancel" statementType="CALLABLE">
	{
        CALL SP_MOM_MATERIAL_PKG.P_CANCEL_MATERIAL_DEDUCT (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{itemId, mode=IN, jdbcType=VARCHAR}
           , #{locationCd, mode=IN, jdbcType=VARCHAR}
           , #{qty, mode=IN, jdbcType=NUMERIC}
           , #{itemStockInoutId, mode=IN, jdbcType=VARCHAR}
           , #{userId, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
</mapper>