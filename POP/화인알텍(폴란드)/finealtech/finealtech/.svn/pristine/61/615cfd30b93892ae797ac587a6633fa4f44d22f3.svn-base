<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.close.daylyStockConfirmSummaryStatus">
	<select id="get_daylyStockConfirmSummaryStatus_list" resultType="camelMap" parameterType="java.util.HashMap">
        WITH IO_TIME AS
        (   SELECT MIN(IO_TIME) BASE_IO_TIME
                 , MAX(IO_TIME) LAST_IO_TIME
              FROM MOM_ITEM_STOCK_CONFIRM_MST
             WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
               AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
               AND IO_TIME BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR},'yyyy-mm-dd')  
                               AND TO_DATE(#{toDate, jdbcType=VARCHAR},'yyyy-mm-dd')
        )
  	     SELECT Z.*
  	       FROM (
		  	     SELECT TO_CHAR(MIN(IO.BASE_IO_TIME), 'yyyy-mm-dd') BASE_IO_TIME
		              , TO_CHAR(MAX(IO.LAST_IO_TIME), 'yyyy-mm-dd') LAST_IO_TIME
		              , A.LOCATION_CD
		              , MAX((SELECT MOM_COMMON_PKG.FN_GET_FACILITY_NAME(A.DIVISION_CD, A.COMPANY_CD, A.LOCATION_CD) FROM DUAL)) LOCATION_NAME
		              , A.ITEM_ID
		              , MAX(B.ITEM_NAME) AS ITEM_NAME
		              , MAX(B.SPECIFICATION) AS SPECIFICATION
		              , MAX(B.ITEM_TYPE) AS ITEM_TYPE
		              , MAX((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.DIVISION_CD, A.COMPANY_CD, 'ITEM_TYPE', B.ITEM_TYPE) FROM DUAL)) ITEM_TYPE_NAME
		              , NVL(MAX(DECODE(A.IO_TIME, IO.BASE_IO_TIME, A.BASIS_QTY, NULL)),0) AS BASIS_QTY
		              , NVL(MAX(DECODE(A.IO_TIME, IO.BASE_IO_TIME, A.BASIS_AMOUNT, NULL)),0) AS BASIS_AMOUNT
		              , SUM(A.INPUT_QTY) AS INPUT_QTY
		              , SUM(A.OUTPUT_QTY) AS OUTPUT_QTY
		              , NVL(MAX(DECODE(A.IO_TIME, IO.LAST_IO_TIME, A.STOCK_QTY, NULL)),0) AS STOCK_QTY
		              , NVL(MAX(DECODE(A.IO_TIME, IO.LAST_IO_TIME, A.STOCK_AMOUNT, NULL)),0) AS STOCK_AMOUNT
		              , MAX(B.ITEM_GROUP_LARGE) AS ITEM_GROUP_LARGE
		              , MAX((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(B.DIVISION_CD, B.COMPANY_CD, 'ITEM_GROUP_LARGE', B.ITEM_GROUP_LARGE) 
		                             FROM DUAL)) AS ITEM_GROUP_LARGE_NAME
		              , MAX(B.ITEM_GROUP_MEDIUM) AS ITEM_GROUP_MEDIUM
		              , MAX((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(B.DIVISION_CD, B.COMPANY_CD, 'ITEM_GROUP_MEDIUM', B.ITEM_GROUP_MEDIUM) 
		                             FROM DUAL)) AS ITEM_GROUP_MEDIUM_NAME
		           FROM MOM_ITEM_STOCK_CONFIRM_MST A
		              , MOM_ITEM_DEFINITION B
		              , IO_TIME IO
		          WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		            AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		           <if test = "fromDate != null and fromDate != ''">
				    AND A.IO_TIME BETWEEN IO.BASE_IO_TIME AND IO.LAST_IO_TIME
				   </if>
		            AND A.ITEM_ID != '-'
		            AND A.DIVISION_CD = B.DIVISION_CD(+)
		            AND A.COMPANY_CD = B.COMPANY_CD(+)
		            AND A.ITEM_ID = B.ITEM_ID(+)
		           <if test = "facilityType != null and facilityType != ''">
				    AND A.LOCATION_CD IN(SELECT FACILITY_CD 
				   						   FROM MOM_FACILITY 
				   						  WHERE DIVISION_CD = A.DIVISION_CD 
				   						    AND COMPANY_CD = A.COMPANY_CD
				   						    AND NVL(USE_YN, 'N') = 'Y' 
				   						    AND FACILITY_TYPE = #{facilityType, jdbcType=VARCHAR})
				   </if>
				   <if test = "location != null and location != ''">
				    AND A.LOCATION_CD = #{location, jdbcType=VARCHAR}
				   </if>
				   <if test = "itemName != null and itemName != ''">
				    AND (A.ITEM_ID LIKE UPPER('%' || #{itemName, jdbcType=VARCHAR} || '%')
				     OR  UPPER(B.ITEM_NAME) LIKE ('%' || UPPER(#{itemName, jdbcType=VARCHAR}) || '%')
				     OR  UPPER(B.SPECIFICATION) LIKE ('%' || UPPER(#{itemName, jdbcType=VARCHAR}) || '%'))
				   </if>
				   <if test = "groupLarge != null and groupLarge != ''">
				    AND B.ITEM_GROUP_LARGE = #{groupLarge, jdbcType=VARCHAR}
				   </if>
				   <if test = "groupMedium != null and groupMedium != ''">
				    AND B.ITEM_GROUP_MEDIUM = #{groupMedium, jdbcType=VARCHAR}
				   </if>
				   <if test = "itemType != null and itemType != ''">
				    AND B.ITEM_TYPE = #{itemType, jdbcType=VARCHAR}
				   </if>
				   GROUP BY A.LOCATION_CD, A.ITEM_ID
				   ) Z
			WHERE 1=1
		   <if test="stockQty != null and stockQty != ''">
             <choose>
                 <when test='stockQty == "N"'>
                     AND Z.STOCK_QTY != 0
                 </when>
                 <when test="stockQty == 'MINUS'">
                     AND Z.STOCK_QTY <![CDATA[<]]> 0
                 </when>
                 <when test="stockQty == 'PLUS'">
                     AND Z.STOCK_QTY > 0
                 </when>
             </choose>
            </if>
          
          ORDER BY Z.LOCATION_CD, Z.ITEM_ID
	</select>
	
</mapper>