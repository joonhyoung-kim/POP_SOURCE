<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.order.B2BIifpp">
	<select id="get_b2biIfPp_list" resultType="camelMap" parameterType="java.util.HashMap">
	WITH TEMP1 AS (
	    SELECT  SEND_SEQ
			  , WORK_DATE
			  , ORGANIZATION_ID
			  , ORGANIZATION_CODE
			  , LINE_CODE
			  , SCHEDULE_GROUP_CODE
			  , WORK_ORDER_NAME
			  , PART_NO
			  , PRIORITY_NO
			  , TOTAL_QTY
			  , REMAINED_QTY
			  , PRODUCTION_DATE
			  , PLAN_QTY
			  , DUE_DATE
			  , MARKET_CODE
			  , MIX_PROD_GROUP_CODE
			  , MIX_PROD_GROUP_SEQ_NO
			  , MIX_PROD_GROUP_RATE
			  , PRODUCTION_START_DATE
			  , PRODUCTION_END_DATE
			  , FROM_SEQUENCE
			  , TO_SEQUENCE
			  , TOOL
			  , IF_ATTRIBUTE1
			  , IF_ATTRIBUTE2
			  , IF_ATTRIBUTE3
			  , IF_ATTRIBUTE4
			  , IF_ATTRIBUTE5
			  , IF_ATTRIBUTE6
			  , IF_ATTRIBUTE7
			  , IF_ATTRIBUTE8
			  , IF_ATTRIBUTE9
			  , IF_ATTRIBUTE10
			  , IF_ATTRIBUTE11
			  , IF_ATTRIBUTE12
			  , IF_ATTRIBUTE13
			  , IF_ATTRIBUTE14
			  , IF_ATTRIBUTE15
			  , IF_ATTRIBUTE16
			  , IF_ATTRIBUTE17
			  , IF_ATTRIBUTE18
			  , IF_ATTRIBUTE19
			  , IF_ATTRIBUTE20
			  , TRANSFER_FLAG
			  , TRANSFER_DATE
			  , NVL((SELECT 'Y' 
                       FROM MOM_PRODUCT_CLASS_REL R 
                      WHERE R.DIVISION_CD      = #{divisionCd, jdbcType=VARCHAR} 
                        AND R.COMPANY_CD       = #{companyCd, jdbcType=VARCHAR} 
                        AND R.PRODUCT_CLASS_ID = P.PART_NO 
                        AND R.USE_YN           = 'Y' 
                        AND ROWNUM             = 1), 'N' ) AS CUSTOMER_MAP_FLAG
	         FROM TU_EAI.IF_LGE_SUP_PRODUCTION_PLAN P
	       WHERE 1 = 1
	         AND EXISTS ( SELECT V.ORGANIZATION_CODE
                            FROM MOM_VENDOR_MAPPING V
                               , MOM_VENDOR_SCHEDULE_GROUP G
	                       WHERE V.DIVISION_CD = G.DIVISION_CD
	                         AND V.COMPANY_CD = G.COMPANY_CD
	                         AND V.ORGANIZATION_CODE = G.ORGANIZATION_CODE
                             AND V.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                             AND V.COMPANY_CD  = #{companyCd, jdbcType=VARCHAR}
                             AND V.ORGANIZATION_CODE = P.ORGANIZATION_CODE
                             AND G.SCHEDULE_GROUP_CD = P.SCHEDULE_GROUP_CODE
                             AND NVL(V.USE_YN, 'Y') = 'Y'
                             AND NVL(G.USE_YN, 'Y') = 'Y' 
                           <if test="organizationCode != null and organizationCode != ''">
					    	 AND P.ORGANIZATION_CODE = #{organizationCode, jdbcType=VARCHAR}
					       </if>
					       <if test="scheduleGroupCode != null and scheduleGroupCode != ''">
					    	 AND P.SCHEDULE_GROUP_CODE = #{scheduleGroupCode, jdbcType=VARCHAR}
					       </if>
                             )
	    <if test="orderSeq == 'CREATE_DATE'">
<!-- 	         AND WORK_DATE BETWEEN TO_NUMBER(REPLACE(#{fromDate, jdbcType=VARCHAR},'-')) AND TO_NUMBER(REPLACE(#{toDate, jdbcType=VARCHAR},'-')) -->
	         AND WORK_DATE = TO_NUMBER(REPLACE(#{fromDate, jdbcType=VARCHAR}, '-'))
	    </if>
<!-- 	    <if test="orderSeq == 'START_DATE'"> -->
<!-- 	    	 AND WORK_DATE = (SELECT MAX(EP.WORK_DATE) -->
<!--                                 FROM TU_EAI.IF_LGE_SUP_PRODUCTION_PLAN EP) -->
<!-- 	         AND PRODUCTION_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND (TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')+ 23.999 / 24) -->
<!-- 	    </if> -->
	    <if test="workOrderName != null and workOrderName != ''">
	         AND UPPER(WORK_ORDER_NAME) LIKE UPPER('%' || #{workOrderName, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="lineCode != null and lineCode != ''">
	         AND UPPER(LINE_CODE) LIKE UPPER('%' || #{lineCode, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="partNo != null and partNo != ''"> 
	         AND UPPER(PART_NO) LIKE UPPER('%' || #{partNo, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="customerMappingFlag != null and customerMappingFlag != ''">
		    <choose>
		    	<when test='customerMappingFlag == "Y"'>
			         AND 0 <![CDATA[<]]> ( SELECT COUNT(*) 
			                      FROM   MOM_PRODUCT_CLASS_REL R 
			                      WHERE  R.DIVISION_CD      = #{divisionCd, jdbcType=VARCHAR} 
			                      AND    R.COMPANY_CD       = #{companyCd, jdbcType=VARCHAR} 
			                      AND    R.PRODUCT_CLASS_ID = P.PART_NO 
			                      AND    R.USE_YN           = 'Y' )
			    </when>
			    <when test='customerMappingFlag == "N"'>
			         AND 0 = ( SELECT COUNT(*) 
			                      FROM   MOM_PRODUCT_CLASS_REL R 
			                      WHERE  R.DIVISION_CD      = #{divisionCd, jdbcType=VARCHAR} 
			                      AND    R.COMPANY_CD       = #{companyCd, jdbcType=VARCHAR} 
			                      AND    R.PRODUCT_CLASS_ID = P.PART_NO 
			                      AND    R.USE_YN           = 'Y' )
			    </when>
		    </choose>
	    </if>
<!-- 	    ORDER BY SEND_SEQ, LINE_CODE, WORK_ORDER_NAME -->
	    )
      SELECT A.*
           , B.ROW_COUNT
      FROM (SELECT A.*
                 , ROWNUM GRIDROW
              FROM TEMP1 A) A
         , (SELECT COUNT(*) ROW_COUNT
              FROM TEMP1) B 
	    <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
		 WHERE GRIDROW BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
	    </if>
	</select>
	
	<select id="get_b2biIfPpCount_list" resultType="camelMap" parameterType="java.util.HashMap">
	      SELECT count(*) AS ROW_COUNT
	        FROM TU_EAI.IF_LGE_SUP_PRODUCTION_PLAN P
	       WHERE 1 = 1
	         AND EXISTS ( SELECT V.ORGANIZATION_CODE
                            FROM MOM_VENDOR_MAPPING V
                               , MOM_VENDOR_SCHEDULE_GROUP G
	                       WHERE V.DIVISION_CD = G.DIVISION_CD
	                         AND V.COMPANY_CD = G.COMPANY_CD
	                         AND V.ORGANIZATION_CODE = G.ORGANIZATION_CODE
                             AND V.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                             AND V.COMPANY_CD  = #{companyCd, jdbcType=VARCHAR}
                             AND V.ORGANIZATION_CODE = P.ORGANIZATION_CODE
                             AND G.SCHEDULE_GROUP_CD = P.SCHEDULE_GROUP_CODE
                             AND NVL(V.USE_YN, 'Y') = 'Y'
                             AND NVL(G.USE_YN, 'Y') = 'Y' 
                           <if test="organizationCode != null and organizationCode != ''">
					    	 AND P.ORGANIZATION_CODE = #{organizationCode, jdbcType=VARCHAR}
					       </if>
					       <if test="scheduleGroupCode != null and scheduleGroupCode != ''">
					    	 AND P.SCHEDULE_GROUP_CODE = #{scheduleGroupCode, jdbcType=VARCHAR}
					       </if>
                             )
	    <if test="orderSeq == 'CREATE_DATE'">
	         AND WORK_DATE BETWEEN TO_NUMBER(REPLACE(#{fromDate, jdbcType=VARCHAR},'-')) AND TO_NUMBER(REPLACE(#{toDate, jdbcType=VARCHAR},'-'))
	    </if>
	    <if test="orderSeq == 'START_DATE'">
	    	 AND WORK_DATE = (SELECT MAX(EP.WORK_DATE)
                                FROM TU_EAI.IF_LGE_SUP_PRODUCTION_PLAN EP)
	         AND PRODUCTION_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND (TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')+ 23.999 / 24)
	    </if>
	    <if test="workOrderName != null and workOrderName != ''">
	         AND UPPER(WORK_ORDER_NAME) LIKE UPPER('%' || #{workOrderName, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="lineCode != null and lineCode != ''">
	         AND UPPER(LINE_CODE) LIKE UPPER('%' || #{lineCode, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="partNo != null and partNo != ''"> 
	         AND UPPER(PART_NO) LIKE UPPER('%' || #{partNo, jdbcType=VARCHAR} || '%')
	    </if>
	    <if test="customerMappingFlag != null and customerMappingFlag != ''">
		    <choose>
		    	<when test='customerMappingFlag == "Y"'>
			         AND 0 <![CDATA[<]]> ( SELECT COUNT(*) 
			                      FROM   MOM_PRODUCT_CLASS_REL R 
			                      WHERE  R.DIVISION_CD      = #{divisionCd, jdbcType=VARCHAR} 
			                      AND    R.COMPANY_CD       = #{companyCd, jdbcType=VARCHAR} 
			                      AND    R.PRODUCT_CLASS_ID = P.PART_NO 
			                      AND    R.USE_YN           = 'Y' )
			    </when>
			    <when test='customerMappingFlag == "N"'>
			         AND 0 = ( SELECT COUNT(*) 
			                      FROM   MOM_PRODUCT_CLASS_REL R 
			                      WHERE  R.DIVISION_CD      = #{divisionCd, jdbcType=VARCHAR} 
			                      AND    R.COMPANY_CD       = #{companyCd, jdbcType=VARCHAR} 
			                      AND    R.PRODUCT_CLASS_ID = P.PART_NO 
			                      AND    R.USE_YN           = 'Y' )
			    </when>
		    </choose>
	    </if>
	</select>
	
	<insert id="create_b2biIfPp" statementType="CALLABLE">
	{
        CALL MOM_B2BI.CREATE_B2BI_PRODUCTION_PLAN (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{userId, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
	
</mapper>