<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.eis.synthesisProductionStatus">
	<select id="get_synthesisProductionStatus_list" resultType="camelMap" parameterType="java.util.HashMap">
		<!-- before -->
<!-- 		WITH DAY AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (SEQ, 1, D_PLAN_NUM, 0) AS D1
                   , DECODE (SEQ, 2, D_PLAN_NUM, 0) AS D2
                   , DECODE (SEQ, 3, D_PLAN_NUM, 0) AS D3
                   , DECODE (SEQ, 4, D_PLAN_NUM, 0) AS D4
                   , DECODE (SEQ, 5, D_PLAN_NUM, 0) AS D5
                   , DECODE (SEQ, 6, D_PLAN_NUM, 0) AS D6
                   , DECODE (SEQ, 7, D_PLAN_NUM, 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE WEEK = #{week, jdbcType=VARCHAR})
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (SEQ, 1, D_RESULT_NUM, 0) AS D1
                   , DECODE (SEQ, 2, D_RESULT_NUM, 0) AS D2
                   , DECODE (SEQ, 3, D_RESULT_NUM, 0) AS D3
                   , DECODE (SEQ, 4, D_RESULT_NUM, 0) AS D4
                   , DECODE (SEQ, 5, D_RESULT_NUM, 0) AS D5
                   , DECODE (SEQ, 6, D_RESULT_NUM, 0) AS D6
                   , DECODE (SEQ, 7, D_RESULT_NUM, 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE WEEK = #{week, jdbcType=VARCHAR})
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (SEQ, 1, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D1
                   , DECODE (SEQ, 2, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D2
                   , DECODE (SEQ, 3, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D3
                   , DECODE (SEQ, 4, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D4
                   , DECODE (SEQ, 5, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D5
                   , DECODE (SEQ, 6, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D6
                   , DECODE (SEQ, 7, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE WEEK = #{week, jdbcType=VARCHAR})
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ),
   WEEK AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (B.W_SEQ, 1, W_PLAN_NUM, 0) AS W1
                   , DECODE (B.W_SEQ, 2, W_PLAN_NUM, 0) AS W2
                   , DECODE (B.W_SEQ, 3, W_PLAN_NUM, 0) AS W3
                   , DECODE (B.W_SEQ, 4, W_PLAN_NUM, 0) AS W4
                   , DECODE (B.W_SEQ, 5, W_PLAN_NUM, 0) AS W5
                   , DECODE (B.W_SEQ, 6, W_PLAN_NUM, 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.WEEKSTART_DATE
	                        , DENSE_RANK () OVER (ORDER BY A.WEEKSTART_DATE) AS W_SEQ
	                     FROM TH_MST_TIME A
	                        , TH_MST_TIME B
	                    WHERE A.WEEKSTART_DATE BETWEEN TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm') AND B.WEEKSTART_DATE
	                      AND B.WEEK = #{week, jdbcType=VARCHAR}
	                    GROUP BY A.WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (B.W_SEQ, 1, W_RESULT_NUM, 0) AS W1
                   , DECODE (B.W_SEQ, 2, W_RESULT_NUM, 0) AS W2
                   , DECODE (B.W_SEQ, 3, W_RESULT_NUM, 0) AS W3
                   , DECODE (B.W_SEQ, 4, W_RESULT_NUM, 0) AS W4
                   , DECODE (B.W_SEQ, 5, W_RESULT_NUM, 0) AS W5
                   , DECODE (B.W_SEQ, 6, W_RESULT_NUM, 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.WEEKSTART_DATE
                            , DENSE_RANK () OVER (ORDER BY A.WEEKSTART_DATE) AS W_SEQ
                         FROM TH_MST_TIME A
                            , TH_MST_TIME B
                        WHERE A.WEEKSTART_DATE BETWEEN TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm') AND B.WEEKSTART_DATE
                          AND B.WEEK = #{week, jdbcType=VARCHAR}
                        GROUP BY A.WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (B.W_SEQ, 1, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W1
                   , DECODE (B.W_SEQ, 2, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W2
                   , DECODE (B.W_SEQ, 3, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W3
                   , DECODE (B.W_SEQ, 4, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W4
                   , DECODE (B.W_SEQ, 5, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W5
                   , DECODE (B.W_SEQ, 6, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.WEEKSTART_DATE
                            , DENSE_RANK () OVER (ORDER BY A.WEEKSTART_DATE) AS W_SEQ
                         FROM TH_MST_TIME A
                            , TH_MST_TIME B
                        WHERE A.WEEKSTART_DATE BETWEEN TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm') AND B.WEEKSTART_DATE
                          AND B.WEEK = #{week, jdbcType=VARCHAR}
                        GROUP BY A.WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ), 
   MONTH AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (B.M_SEQ, 1, M_PLAN_NUM, 0) AS M1
                   , DECODE (B.M_SEQ, 2, M_PLAN_NUM, 0) AS M2
                   , DECODE (B.M_SEQ, 3, M_PLAN_NUM, 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.YEAR || A.MONTH AS YYYYMM
	                        , DENSE_RANK () OVER (ORDER BY A.YEAR || A.MONTH) AS M_SEQ
	                     FROM TH_MST_TIME A
	                        , TH_MST_TIME B
	                    WHERE A.DATE_ID BETWEEN ADD_MONTHS (TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm'), -2) AND B.WEEKSTART_DATE
	                      AND B.WEEK = #{week, jdbcType=VARCHAR}
	                 GROUP BY A.YEAR || A.MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (B.M_SEQ, 1, M_RESULT_NUM, 0) AS M1
                   , DECODE (B.M_SEQ, 2, M_RESULT_NUM, 0) AS M2
                   , DECODE (B.M_SEQ, 3, M_RESULT_NUM, 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.YEAR || A.MONTH AS YYYYMM
                            , DENSE_RANK () OVER (ORDER BY A.YEAR || A.MONTH) AS M_SEQ
                         FROM TH_MST_TIME A
                            , TH_MST_TIME B
                        WHERE A.DATE_ID BETWEEN ADD_MONTHS (TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm'), -2) AND B.WEEKSTART_DATE
                          AND B.WEEK = #{week, jdbcType=VARCHAR}
                     GROUP BY A.YEAR || A.MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (B.M_SEQ, 1, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M1
                   , DECODE (B.M_SEQ, 2, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M2
                   , DECODE (B.M_SEQ, 3, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , ( SELECT A.YEAR || A.MONTH AS YYYYMM
                            , DENSE_RANK () OVER (ORDER BY A.YEAR || A.MONTH) AS M_SEQ
                         FROM TH_MST_TIME A
                            , TH_MST_TIME B
                        WHERE A.DATE_ID BETWEEN ADD_MONTHS (TO_DATE (TO_CHAR (B.WEEKSTART_DATE, 'YYYYMM'), 'yyyymm'), -2) AND B.WEEKSTART_DATE
                          AND B.WEEK = #{week, jdbcType=VARCHAR}
                     GROUP BY A.YEAR || A.MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ),
   MAX_DATA AS (
    SELECT D.PLACE_CD
         , D.RESOURCE_GROUP_CD
         , D.ITEM_GROUP
         , D.DATA_TYPE
         , D.TYPE
         , MAX (M1) AS M1
         , MAX (M2) AS M2
         , MAX (M3) AS M3
         , MAX (W1) AS W1
         , MAX (W2) AS W2
         , MAX (W3) AS W3
         , MAX (W4) AS W4
         , MAX (W5) AS W5
         , MAX (W6) AS W6
         , MAX (D1) AS D1
         , MAX (D2) AS D2
         , MAX (D3) AS D3
         , MAX (D4) AS D4
         , MAX (D5) AS D5
         , MAX (D6) AS D6
         , MAX (D7) AS D7  
      FROM (     
            SELECT D.PLACE_CD
                 , D.RESOURCE_GROUP_CD
                 , D.ITEM_GROUP
                 , D.DATA_TYPE
                 , D.TYPE
                 , 0 AS M1
                 , 0 AS M2
                 , 0 AS M3
                 , 0 AS W1
                 , 0 AS W2
                 , 0 AS W3
                 , 0 AS W4
                 , 0 AS W5
                 , 0 AS W6
                 , MAX (D1) AS D1
                 , MAX (D2) AS D2
                 , MAX (D3) AS D3
                 , MAX (D4) AS D4
                 , MAX (D5) AS D5
                 , MAX (D6) AS D6
                 , MAX (D7) AS D7
              FROM DAY D
             GROUP BY D.PLACE_CD
                    , D.RESOURCE_GROUP_CD
                    , D.ITEM_GROUP
                    , D.DATA_TYPE
                    , D.TYPE
            UNION 
            SELECT W.PLACE_CD
                 , W.RESOURCE_GROUP_CD
                 , W.ITEM_GROUP
                 , W.DATA_TYPE
                 , W.TYPE
                 , 0 AS M1
                 , 0 AS M2
                 , 0 AS M3
                 , MAX (W1) AS W1
                 , MAX (W2) AS W2
                 , MAX (W3) AS W3
                 , MAX (W4) AS W4
                 , MAX (W5) AS W5
                 , MAX (W6) AS W6
                 , 0 AS D1
                 , 0 AS D2
                 , 0 AS D3
                 , 0 AS D4
                 , 0 AS D5
                 , 0 AS D6
                 , 0 AS D7
              FROM WEEK W
             GROUP BY W.PLACE_CD
                    , W.RESOURCE_GROUP_CD
                    , W.ITEM_GROUP
                    , W.DATA_TYPE
                    , W.TYPE
            UNION 
            SELECT M.PLACE_CD
                 , M.RESOURCE_GROUP_CD
                 , M.ITEM_GROUP
                 , M.DATA_TYPE
                 , M.TYPE
                 , MAX(M1) AS M1
                 , MAX(M2) AS M2
                 , MAX(M3) AS M3
                 , 0 AS W1
                 , 0 AS W2
                 , 0 AS W3
                 , 0 AS W4
                 , 0 AS W5
                 , 0 AS W6
                 , 0 AS D1
                 , 0 AS D2
                 , 0 AS D3
                 , 0 AS D4
                 , 0 AS D5
                 , 0 AS D6
                 , 0 AS D7
              FROM MONTH M
             GROUP BY M.PLACE_CD
                    , M.RESOURCE_GROUP_CD
                    , M.ITEM_GROUP
                    , M.DATA_TYPE
                    , M.TYPE
           ) D
     GROUP BY D.PLACE_CD
            , D.RESOURCE_GROUP_CD
            , D.ITEM_GROUP
            , D.DATA_TYPE
            , D.TYPE
   ) 
  SELECT Z.PLACE_CD
       , MC.CODE_NAME AS PLACE_NAME
       , MC.UI_SEQUENCE AS PLACE_SEQ
       , Z.RESOURCE_GROUP_CD
       , NVL((SELECT MOM_COMMON_PKG.FN_GET_RESOURCE_GROUP_NAME( #{divisionCd, jdbcType=VARCHAR}
                                                          , #{companyCd, jdbcType=VARCHAR}
                                                          , Z.RESOURCE_GROUP_CD) 
                FROM DUAL)
            , Z.RESOURCE_GROUP_CD) AS RESOURCE_GROUP_NAME
       , Z.ITEM_GROUP
       , NVL((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME( #{divisionCd, jdbcType=VARCHAR}
                                                    , #{companyCd, jdbcType=VARCHAR}
                                                    , 'ITEM_GROUP_LARGE'
                                                    , Z.ITEM_GROUP) 
                FROM DUAL)
            , Z.ITEM_GROUP) AS ITEM_GROUP_NAME
       , Z.DATA_TYPE
       , DECODE(Z.DATA_TYPE, 'QTY', '생산수량', '생산금액') AS DATA_TYPE_NAME
       , DECODE(Z.TYPE, '1', '계획', '2', '실적', '3', '%') AS TYPE
       ${pivot1}
	   ${pivot2}
	   ${pivot3}
    FROM (SELECT NVL(PLACE_CD, 'ETC') AS PLACE_CD
               , RESOURCE_GROUP_CD
               , ITEM_GROUP
               , DATA_TYPE
               , TYPE
               , M1
               , M2
               , M3
               , W1
               , W2
               , W3
               , W4
               , W5
               , W6
               , D1
               , D2
               , D3
               , D4
               , D5
               , D6
               , D7
            FROM MAX_DATA
           UNION
           SELECT NVL(PLACE_CD, 'ETC') AS PLACE_CD
                , RESOURCE_GROUP_CD
                , 'TOTAL' ITEM_GROUP
                , DATA_TYPE
                , TYPE
                , DECODE(TYPE, '3', AVG(M1), SUM(M1)) AS M1
                , DECODE(TYPE, '3', AVG(M2), SUM(M2)) AS M2
                , DECODE(TYPE, '3', AVG(M3), SUM(M3)) AS M3
                , DECODE(TYPE, '3', AVG(W1), SUM(W1)) AS W1
                , DECODE(TYPE, '3', AVG(W2), SUM(W2)) AS W2
                , DECODE(TYPE, '3', AVG(W3), SUM(W3)) AS W3
                , DECODE(TYPE, '3', AVG(W4), SUM(W4)) AS W4
                , DECODE(TYPE, '3', AVG(W5), SUM(W5)) AS W5
                , DECODE(TYPE, '3', AVG(W6), SUM(W6)) AS W6
                , DECODE(TYPE, '3', AVG(D1), SUM(D1)) AS D1
                , DECODE(TYPE, '3', AVG(D2), SUM(D2)) AS D2
                , DECODE(TYPE, '3', AVG(D3), SUM(D3)) AS D3
                , DECODE(TYPE, '3', AVG(D4), SUM(D4)) AS D4
                , DECODE(TYPE, '3', AVG(D5), SUM(D5)) AS D5
                , DECODE(TYPE, '3', AVG(D6), SUM(D6)) AS D6
                , DECODE(TYPE, '3', AVG(D7), SUM(D7)) AS D7
           FROM MAX_DATA
           GROUP BY PLACE_CD
                , RESOURCE_GROUP_CD
                , DATA_TYPE
                , TYPE
        ) Z
        , MOM_CODE MC
    WHERE MC.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
      AND MC.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
      AND MC.CODE_CLASS_ID = 'EQM_LOCATION'
      AND Z.PLACE_CD = MC.CODE_ID
     <if test="placeCd != null and placeCd != ''">
      AND Z.PLACE_CD = #{placeCd, jdbcType=VARCHAR} 
     </if>
     <if test="resourceGroupCd != null and resourceGroupCd != ''">
      AND Z.RESOURCE_GROUP_CD = #{resourceGroupCd, jdbcType=VARCHAR} 
     </if>
   ORDER BY PLACE_SEQ
          , Z.RESOURCE_GROUP_CD
          , Z.ITEM_GROUP
          , Z.DATA_TYPE
          , DECODE(TYPE, '1', '계획', '2', '실적', '3', '%')
 -->

        WITH DAY AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (SEQ, 1, D_PLAN_NUM, 0) AS D1
                   , DECODE (SEQ, 2, D_PLAN_NUM, 0) AS D2
                   , DECODE (SEQ, 3, D_PLAN_NUM, 0) AS D3
                   , DECODE (SEQ, 4, D_PLAN_NUM, 0) AS D4
                   , DECODE (SEQ, 5, D_PLAN_NUM, 0) AS D5
                   , DECODE (SEQ, 6, D_PLAN_NUM, 0) AS D6
                   , DECODE (SEQ, 7, D_PLAN_NUM, 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE DATE_ID = TO_DATE(#{weekStartDate, jdbcType=VARCHAR}, 'YYYYMMDD'))
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (SEQ, 1, D_RESULT_NUM, 0) AS D1
                   , DECODE (SEQ, 2, D_RESULT_NUM, 0) AS D2
                   , DECODE (SEQ, 3, D_RESULT_NUM, 0) AS D3
                   , DECODE (SEQ, 4, D_RESULT_NUM, 0) AS D4
                   , DECODE (SEQ, 5, D_RESULT_NUM, 0) AS D5
                   , DECODE (SEQ, 6, D_RESULT_NUM, 0) AS D6
                   , DECODE (SEQ, 7, D_RESULT_NUM, 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE DATE_ID = TO_DATE(#{weekStartDate, jdbcType=VARCHAR}, 'YYYYMMDD'))
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (SEQ, 1, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D1
                   , DECODE (SEQ, 2, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D2
                   , DECODE (SEQ, 3, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D3
                   , DECODE (SEQ, 4, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D4
                   , DECODE (SEQ, 5, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D5
                   , DECODE (SEQ, 6, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D6
                   , DECODE (SEQ, 7, TRUNC (D_RESULT_NUM / DECODE (D_PLAN_NUM, 0, NULL, D_PLAN_NUM) * 100, 1), 0) AS D7
                FROM MOM_EIS_PRODUCE_STATUS
               WHERE W_START_DATE = (SELECT DISTINCT TO_CHAR (WEEKSTART_DATE, 'yyyymmdd')
                                       FROM TH_MST_TIME
                                      WHERE DATE_ID = TO_DATE(#{weekStartDate, jdbcType=VARCHAR}, 'YYYYMMDD'))
                 AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ),
   WEEK AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (B.W_SEQ, 1, W_PLAN_NUM, 0) AS W1
                   , DECODE (B.W_SEQ, 2, W_PLAN_NUM, 0) AS W2
                   , DECODE (B.W_SEQ, 3, W_PLAN_NUM, 0) AS W3
                   , DECODE (B.W_SEQ, 4, W_PLAN_NUM, 0) AS W4
                   , DECODE (B.W_SEQ, 5, W_PLAN_NUM, 0) AS W5
                   , DECODE (B.W_SEQ, 6, W_PLAN_NUM, 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT WEEKSTART_DATE, DENSE_RANK () OVER (ORDER BY WEEKSTART_DATE) AS W_SEQ
                          FROM TH_MST_TIME
                         WHERE WEEKSTART_DATE BETWEEN TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm') 
                                                  AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (B.W_SEQ, 1, W_RESULT_NUM, 0) AS W1
                   , DECODE (B.W_SEQ, 2, W_RESULT_NUM, 0) AS W2
                   , DECODE (B.W_SEQ, 3, W_RESULT_NUM, 0) AS W3
                   , DECODE (B.W_SEQ, 4, W_RESULT_NUM, 0) AS W4
                   , DECODE (B.W_SEQ, 5, W_RESULT_NUM, 0) AS W5
                   , DECODE (B.W_SEQ, 6, W_RESULT_NUM, 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT WEEKSTART_DATE, DENSE_RANK () OVER (ORDER BY WEEKSTART_DATE) AS W_SEQ
                          FROM TH_MST_TIME
                         WHERE WEEKSTART_DATE BETWEEN TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm') 
                                                  AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (B.W_SEQ, 1, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W1
                   , DECODE (B.W_SEQ, 2, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W2
                   , DECODE (B.W_SEQ, 3, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W3
                   , DECODE (B.W_SEQ, 4, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W4
                   , DECODE (B.W_SEQ, 5, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W5
                   , DECODE (B.W_SEQ, 6, TRUNC (W_RESULT_NUM / DECODE (W_PLAN_NUM, 0, NULL, W_PLAN_NUM) * 100, 1), 0) AS W6
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT WEEKSTART_DATE, DENSE_RANK () OVER (ORDER BY WEEKSTART_DATE) AS W_SEQ
                          FROM TH_MST_TIME
                         WHERE WEEKSTART_DATE BETWEEN TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm') 
                                                  AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY WEEKSTART_DATE) B
               WHERE A.W_START_DATE = TO_CHAR(B.WEEKSTART_DATE,'yyyymmdd')
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ), 
   MONTH AS (
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '1' AS TYPE
                   , DECODE (B.M_SEQ, 1, M_PLAN_NUM, 0) AS M1
                   , DECODE (B.M_SEQ, 2, M_PLAN_NUM, 0) AS M2
                   , DECODE (B.M_SEQ, 3, M_PLAN_NUM, 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT YEAR || MONTH AS YYYYMM
                             , DENSE_RANK () OVER (ORDER BY YEAR || MONTH) AS M_SEQ
                             , MAX (DATE_ID) AS DATE_ID
                          FROM TH_MST_TIME
                         WHERE DATE_ID BETWEEN ADD_MONTHS (TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm'), -2) 
                                           AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY YEAR, MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '2' AS TYPE
                   , DECODE (B.M_SEQ, 1, M_RESULT_NUM, 0) AS M1
                   , DECODE (B.M_SEQ, 2, M_RESULT_NUM, 0) AS M2
                   , DECODE (B.M_SEQ, 3, M_RESULT_NUM, 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT YEAR || MONTH AS YYYYMM
                             , DENSE_RANK () OVER (ORDER BY YEAR || MONTH) AS M_SEQ
                             , MAX (DATE_ID) AS DATE_ID
                          FROM TH_MST_TIME
                         WHERE DATE_ID BETWEEN ADD_MONTHS (TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm'), -2) 
                                           AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY YEAR, MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
              UNION 
              SELECT PLACE_CD
                   , RESOURCE_GROUP_CD
                   , ITEM_GROUP
                   , DATA_TYPE
                   , '3' AS TYPE
                   , DECODE (B.M_SEQ, 1, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M1
                   , DECODE (B.M_SEQ, 2, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M2
                   , DECODE (B.M_SEQ, 3, TRUNC (M_RESULT_NUM / DECODE (M_PLAN_NUM, 0, NULL, M_PLAN_NUM) * 100, 1), 0) AS M3
                FROM MOM_EIS_PRODUCE_STATUS A
                   , (  SELECT YEAR || MONTH AS YYYYMM
                             , DENSE_RANK () OVER (ORDER BY YEAR || MONTH) AS M_SEQ
                             , MAX (DATE_ID) AS DATE_ID
                          FROM TH_MST_TIME
                         WHERE DATE_ID BETWEEN ADD_MONTHS (TO_DATE (SUBSTR (#{weekStartDate, jdbcType=VARCHAR}, 0, 6), 'yyyymm'), -2) 
                                           AND TO_DATE (#{weekStartDate, jdbcType=VARCHAR}, 'yyyymmdd')
                      GROUP BY YEAR, MONTH) B
               WHERE A.YYYYMM = B.YYYYMM 
                 AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                 AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   ),
   MAX_DATA AS (
    SELECT D.PLACE_CD
         , D.RESOURCE_GROUP_CD
         , D.ITEM_GROUP
         , D.DATA_TYPE
         , D.TYPE
         , MAX (M1) AS M1
         , MAX (M2) AS M2
         , MAX (M3) AS M3
         , MAX (W1) AS W1
         , MAX (W2) AS W2
         , MAX (W3) AS W3
         , MAX (W4) AS W4
         , MAX (W5) AS W5
         , MAX (W6) AS W6
         , MAX (D1) AS D1
         , MAX (D2) AS D2
         , MAX (D3) AS D3
         , MAX (D4) AS D4
         , MAX (D5) AS D5
         , MAX (D6) AS D6
         , MAX (D7) AS D7  
      FROM (     
            SELECT D.PLACE_CD
                 , D.RESOURCE_GROUP_CD
                 , D.ITEM_GROUP
                 , D.DATA_TYPE
                 , D.TYPE
                 , 0 AS M1
                 , 0 AS M2
                 , 0 AS M3
                 , 0 AS W1
                 , 0 AS W2
                 , 0 AS W3
                 , 0 AS W4
                 , 0 AS W5
                 , 0 AS W6
                 , MAX (D1) AS D1
                 , MAX (D2) AS D2
                 , MAX (D3) AS D3
                 , MAX (D4) AS D4
                 , MAX (D5) AS D5
                 , MAX (D6) AS D6
                 , MAX (D7) AS D7
              FROM DAY D
             GROUP BY D.PLACE_CD
                    , D.RESOURCE_GROUP_CD
                    , D.ITEM_GROUP
                    , D.DATA_TYPE
                    , D.TYPE
            UNION 
            SELECT W.PLACE_CD
                 , W.RESOURCE_GROUP_CD
                 , W.ITEM_GROUP
                 , W.DATA_TYPE
                 , W.TYPE
                 , 0 AS M1
                 , 0 AS M2
                 , 0 AS M3
                 , MAX (W1) AS W1
                 , MAX (W2) AS W2
                 , MAX (W3) AS W3
                 , MAX (W4) AS W4
                 , MAX (W5) AS W5
                 , MAX (W6) AS W6
                 , 0 AS D1
                 , 0 AS D2
                 , 0 AS D3
                 , 0 AS D4
                 , 0 AS D5
                 , 0 AS D6
                 , 0 AS D7
              FROM WEEK W
             GROUP BY W.PLACE_CD
                    , W.RESOURCE_GROUP_CD
                    , W.ITEM_GROUP
                    , W.DATA_TYPE
                    , W.TYPE
            UNION 
            SELECT M.PLACE_CD
                 , M.RESOURCE_GROUP_CD
                 , M.ITEM_GROUP
                 , M.DATA_TYPE
                 , M.TYPE
                 , MAX(M1) AS M1
                 , MAX(M2) AS M2
                 , MAX(M3) AS M3
                 , 0 AS W1
                 , 0 AS W2
                 , 0 AS W3
                 , 0 AS W4
                 , 0 AS W5
                 , 0 AS W6
                 , 0 AS D1
                 , 0 AS D2
                 , 0 AS D3
                 , 0 AS D4
                 , 0 AS D5
                 , 0 AS D6
                 , 0 AS D7
              FROM MONTH M
             GROUP BY M.PLACE_CD
                    , M.RESOURCE_GROUP_CD
                    , M.ITEM_GROUP
                    , M.DATA_TYPE
                    , M.TYPE
           ) D
     GROUP BY D.PLACE_CD
            , D.RESOURCE_GROUP_CD
            , D.ITEM_GROUP
            , D.DATA_TYPE
            , D.TYPE
   ) 
  SELECT Z.PLACE_CD
       , MC.CODE_NAME AS PLACE_NAME
       , MC.UI_SEQUENCE AS PLACE_SEQ
       , Z.RESOURCE_GROUP_CD
       , NVL((SELECT MOM_COMMON_PKG.FN_GET_RESOURCE_GROUP_NAME( #{divisionCd, jdbcType=VARCHAR}
                                                          , #{companyCd, jdbcType=VARCHAR}
                                                          , Z.RESOURCE_GROUP_CD) 
                FROM DUAL)
            , Z.RESOURCE_GROUP_CD) AS RESOURCE_GROUP_NAME
       , Z.ITEM_GROUP
       , NVL((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME( #{divisionCd, jdbcType=VARCHAR}
                                                    , #{companyCd, jdbcType=VARCHAR}
                                                    , 'ITEM_GROUP_LARGE'
                                                    , Z.ITEM_GROUP) 
                FROM DUAL)
            , Z.ITEM_GROUP) AS ITEM_GROUP_NAME
       , Z.DATA_TYPE
       , DECODE(Z.DATA_TYPE, 'QTY', '생산수량', '생산금액') AS DATA_TYPE_NAME
       , DECODE(Z.TYPE, '1', '계획', '2', '실적', '3', '%') AS TYPE
       ${pivot1}
       ${pivot2}
       ${pivot3}
    FROM (SELECT NVL(PLACE_CD, 'ETC') AS PLACE_CD
               , RESOURCE_GROUP_CD
               , ITEM_GROUP
               , DATA_TYPE
               , TYPE
               , M1
               , M2
               , M3
               , W1
               , W2
               , W3
               , W4
               , W5
               , W6
               , D1
               , D2
               , D3
               , D4
               , D5
               , D6
               , D7
            FROM MAX_DATA
           UNION
           SELECT NVL(PLACE_CD, 'ETC') AS PLACE_CD
                , RESOURCE_GROUP_CD
                , 'TOTAL' ITEM_GROUP
                , DATA_TYPE
                , TYPE
                , DECODE(TYPE, '3', AVG(M1), SUM(M1)) AS M1
                , DECODE(TYPE, '3', AVG(M2), SUM(M2)) AS M2
                , DECODE(TYPE, '3', AVG(M3), SUM(M3)) AS M3
                , DECODE(TYPE, '3', AVG(W1), SUM(W1)) AS W1
                , DECODE(TYPE, '3', AVG(W2), SUM(W2)) AS W2
                , DECODE(TYPE, '3', AVG(W3), SUM(W3)) AS W3
                , DECODE(TYPE, '3', AVG(W4), SUM(W4)) AS W4
                , DECODE(TYPE, '3', AVG(W5), SUM(W5)) AS W5
                , DECODE(TYPE, '3', AVG(W6), SUM(W6)) AS W6
                , DECODE(TYPE, '3', AVG(D1), SUM(D1)) AS D1
                , DECODE(TYPE, '3', AVG(D2), SUM(D2)) AS D2
                , DECODE(TYPE, '3', AVG(D3), SUM(D3)) AS D3
                , DECODE(TYPE, '3', AVG(D4), SUM(D4)) AS D4
                , DECODE(TYPE, '3', AVG(D5), SUM(D5)) AS D5
                , DECODE(TYPE, '3', AVG(D6), SUM(D6)) AS D6
                , DECODE(TYPE, '3', AVG(D7), SUM(D7)) AS D7
           FROM MAX_DATA
           GROUP BY PLACE_CD
                , RESOURCE_GROUP_CD
                , DATA_TYPE
                , TYPE
        ) Z
        , MOM_CODE MC
    WHERE MC.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
      AND MC.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
      AND MC.CODE_CLASS_ID = 'EQM_LOCATION'
      AND Z.PLACE_CD = MC.CODE_ID
     <if test="placeCd != null and placeCd != ''">
      AND Z.PLACE_CD = #{placeCd, jdbcType=VARCHAR} 
     </if>
     <if test="resourceGroupCd != null and resourceGroupCd != ''">
      AND Z.RESOURCE_GROUP_CD = #{resourceGroupCd, jdbcType=VARCHAR} 
     </if>
   ORDER BY PLACE_SEQ
          , Z.RESOURCE_GROUP_CD
          , Z.ITEM_GROUP
          , Z.DATA_TYPE
          , Z.TYPE

		
	</select>
	
</mapper>