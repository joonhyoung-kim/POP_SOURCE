<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.equipment.equipmentWoStatus">
	<select id="get_equipmentWoStatus_list" resultType="camelMap" parameterType="java.util.HashMap">
		<if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
		WITH TEMP1 AS (	
	    </if>
	    SELECT TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS WO_DATE
		     , A.EQM_WO_ID
		     , A.EQM_WO_NAME
		     , A.EQM_TYPE
		     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME (A.DIVISION_CD
		     										  , A.COMPANY_CD
		     										  , 'EQ_WO_TYPE'
		     										  , A.EQM_TYPE)
		          FROM DUAL) AS EQM_TYPE_NAME
		     , EQUIPMENT_CD
		     , (SELECT MOM_COMMON_PKG.FN_GET_EQUIPMENT_NAME(A.DIVISION_CD
		     											  , A.COMPANY_CD
		     											  , A.EQUIPMENT_CD)
		          FROM DUAL) AS EQUIPMENT_NAME
		     , A.PRIORITY
		     , A.STATUS
		     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME (A.DIVISION_CD
		     										  , A.COMPANY_CD
		     										  , 'EQM_WORK_ORDER_STATUS'
		     										  , A.STATUS)
		          FROM DUAL) AS STATUS_NAME
		     , A.EQM_QTY
		     , A.RESULT_QTY
		     , A.CANCEL_QTY 
		     , (A.EQM_QTY - NVL(A.RESULT_QTY, 0) - NVL(A.CANCEL_QTY, 0)) AS REMAIN_QTY
		     , A.DESCRIPTION
		     , TO_CHAR(A.CANCEL_DATE, 'YYYY-MM-DD') AS CANCEL_DATE
			 , A.CANCEL_REASON
			 , TO_CHAR(A.CREATE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS CREATE_DATE
			 , A.CREATE_BY
			 , (SELECT MOM_COMMON_PKG.FN_GET_USER_NAME( A.DIVISION_CD
	                                                  , A.COMPANY_CD  
	                                                  , A.CREATE_BY)
	              FROM DUAL) AS CREATE_BY_NAME 
			 , TO_CHAR(A.UPDATE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS UPDATE_DATE
			 , A.UPDATE_BY
			 , (SELECT MOM_COMMON_PKG.FN_GET_USER_NAME( A.DIVISION_CD
	                                                  , A.COMPANY_CD  
	                                                  , A.UPDATE_BY)
	              FROM DUAL) AS UPDATE_BY_NAME
		  FROM MOM_EQM_WORK_ORDER A
		 WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		   AND A.PLAN_START_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR},'YYYY-MM-DD') AND TO_DATE(#{toDate, jdbcType=VARCHAR},'YYYY-MM-DD') + 23.9997 / 24
		   <if test="equipmentCd != null and equipmentCd != ''">
           AND A.EQUIPMENT_CD = #{equipmentCd, jdbcType=VARCHAR}
           </if>
           <if test="woType != null and woType != ''">
           AND A.EQM_TYPE = #{woType, jdbcType=VARCHAR}
           </if>
           <if test="woId != null and woId != ''">
           AND (A.EQM_WO_ID LIKE '%' || TRIM(UPPER(#{woId, jdbcType=VARCHAR})) || '%'
            OR A.EQM_WO_NAME LIKE '%' || TRIM(UPPER(#{woId, jdbcType=VARCHAR})) || '%')
           </if>
           <if test="state != null and state != ''">
           AND A.STATUS = #{state, jdbcType=VARCHAR}
           </if>
		 ORDER BY EQM_WO_ID 
	   <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
				)
	      SELECT A.*
	           , B.ROW_COUNT
	      FROM (SELECT A.*
	                 , ROWNUM GRIDROW
	              FROM TEMP1 A) A
	         , (SELECT COUNT(*) ROW_COUNT
	              FROM TEMP1) B 
	      WHERE GRIDROW BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
       </if>
    </select>
    
    <delete id="remove_equipmentWoCancelTemp" parameterType="java.util.HashMap">
		DELETE 
		  FROM MOM_EQM_ORDER_REQUEST_TMP
 		 WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
   		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
   		   AND WO_FLAG = 'CANCEL'
   		
	</delete>
	
	<insert id="create_equipmentWoCancelTemp" parameterType="java.util.HashMap">
	INSERT INTO MOM_EQM_ORDER_REQUEST_TMP
			( DIVISION_CD
			, COMPANY_CD
			, EQM_TYPE
			, EQM_WO_ID
			, EQM_WO_NAME
			, EQUIPMENT_CD
			, EQM_QTY
			, PLAN_START_DATE
			, PLAN_END_DATE
			, STATUS
			, REASON_CODE
			, DESCRIPTION
			, CREATE_DATE
			, CREATE_BY
			, PRIORITY
			, WO_FLAG
			)
		SELECT DIVISION_CD
			 , COMPANY_CD
			 , EQM_TYPE
			 , EQM_WO_ID
			 , EQM_WO_NAME
			 , EQUIPMENT_CD
			 , EQM_QTY
			 , PLAN_START_DATE
			 , PLAN_END_DATE
			 , STATUS
			 , REASON_CODE
			 , DESCRIPTION
			 , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR})
		     , #{updateBy, jdbcType=VARCHAR}
			 , PRIORITY
			 , 'CANCEL'
		  FROM MOM_EQM_ORDER_REQUEST
		 WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		   AND EQM_WO_ID = #{eqmWoId, jdbcType=VARCHAR}
	</insert>

	<insert id="create_cancelEquipmentWo" statementType="CALLABLE">
	{
        CALL SP_MOM_EQUIPMENT_PKG.P_CANCEL_WORK_ORDER (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{eqmWoId, jdbcType=VARCHAR}
           , #{eqmQty, jdbcType=NUMERIC}
           , TO_DATE(#{cancelDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
           , #{cancelReason, mode=IN, jdbcType=VARCHAR}
           , #{createBy, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
</mapper>