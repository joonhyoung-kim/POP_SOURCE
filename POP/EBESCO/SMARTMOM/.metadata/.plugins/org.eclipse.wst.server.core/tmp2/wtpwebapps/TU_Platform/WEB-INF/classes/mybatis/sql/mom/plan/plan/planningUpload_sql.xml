<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.plan.planningUpload">
<select id="get_planningUpload_list" resultType="camelMap" parameterType="java.util.HashMap">
			SELECT   MIN(A.WORK_SEQ) AS WORK_SEQ
	               , A.ROUTE_CD
	               , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(R.DIVISION_CD, R.COMPANY_CD, 'ROUTE_CODE', A.ROUTE_CD)
	                    FROM   DUAL ) AS ROUTE_NAME
	               , A.RESOURCE_ID
	               , MIN(R.RESOURCE_NAME) AS RESOURCE_NAME
	               , A.WORK_ORDER_ID
	               , A.ITEM_ID
	               , MIN(B.ITEM_NAME) AS ITEM_NAME
	               , MIN(B.SPECIFICATION) AS SPECIFICATION
	               , MIN(B.ITEM_GROUP_CODE) AS ITEM_GROUP_CODE
	               , SUM(A.WORK_QTY) AS WORK_QTY
	               , MIN(TO_CHAR(A.OUTPUT_TIME, 'YYYY-MM-DD')) AS OUTPUT_TIME
	               , MIN(TO_CHAR(A.PLAN_DATE, 'YYYY-MM-DD')) AS PLAN_DATE
	               , MIN(TO_CHAR(A.WORK_DATE, 'YYYY-MM-DD')) AS WORK_DATE
	               , MIN(TO_CHAR(A.DUE_DATE, 'YYYY-MM-DD')) AS DUE_DATE
	               , MIN (A.CUSTOMER_LINE_CD) AS CUSTOMER_LINE_CD
                   , MIN (A.CUSTOMER_MODEL) AS CUSTOMER_MODEL
	               , MIN(A.DEMAND_ID) AS DEMAND_ID
	               <!-- 2018.12.31 hyjeong begin -->
<!-- 	               , A.ATTR1 -->
	                <if test = "pivot != null and pivot != ''">
	               , ${pivot}
	               </if>
	               <!-- 2018.12.31 hyjeong end -->
	        FROM   TH_BUFMOM_PRODUCTIONPLANDETAIL A
	             , MOM_ITEM_DEFINITION B
	             , MOM_RESOURCE R
	        WHERE  A.MASTER_ID = B.DIVISION_CD
	        AND    A.ITEM_ID   = B.ITEM_ID
	        AND    A.MASTER_ID = R.DIVISION_CD
	        AND    A.RESOURCE_ID   = R.RESOURCE_CD 
	        AND    A.MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
<!-- 	        AND    A.PLAN_DATE  = TO_DATE(#{planDate, jdbcType=VARCHAR}) -->
	        GROUP  BY R.DIVISION_CD
	                , R.COMPANY_CD
	                , A.MASTER_ID
	                , A.ITEM_ID
	                , A.ROUTE_CD
	                , A.RESOURCE_ID 
	                , A.WORK_ORDER_ID
<!-- 	                , A.WORK_SEQ -->
<!-- 	                , A.CUSTOMER_LINE_CD -->
<!-- 	                , A.CUSTOMER_MODEL -->
<!-- 	                , A.WORK_DATE -->
	                <!-- 2018.12.31 hyjeong begin -->
<!-- 	               , A.ATTR1 -->
	                <!-- 2018.12.31 hyjeong end -->
<!-- 	        ORDER BY A.WORK_SEQ -->
			ORDER BY A.RESOURCE_ID, A.ITEM_ID
</select>	
	
<insert id="create_planningUpload">
	INSERT INTO TH_BUFMOM_PRODUCTIONPLANDETAIL
			(MASTER_ID
			, PLAN_DATE
			, RESOURCE_ID
			, ROUTE_CD
			, ITEM_ID
			, WORK_DATE
			, WORK_QTY
			, ITEM_UOM
			, WORK_ORDER_ID
			, DEMAND_ID
			, NET_DEMAND_ID
			, WORK_SEQ
			, CUSTOMER_LINE_CD
	        , CUSTOMER_MODEL
	        , OUTPUT_TIME
	        , DUE_DATE
	        <!-- 2018.12-31 hyjeong begin -->
	        , ATTR1
	        <!-- 2018.12-31 hyjeong end -->
	       <if test="key != null and key != ''">
	        ${key}
	       </if>
			)
	VALUES  (
			#{divisionCd, jdbcType=VARCHAR},
			TO_DATE(#{planDate, jdbcType=VARCHAR}, 'YYYY-MM-DD'),
			TRIM(UPPER(#{resourceId, jdbcType=VARCHAR})),
			TRIM(UPPER(#{routeCd, jdbcType=VARCHAR})),
			TRIM(UPPER(#{itemId, jdbcType=VARCHAR})),
			TO_DATE(#{workDate, jdbcType=VARCHAR}, 'YYYY-MM-DD'),
			#{workQty, jdbcType=INTEGER},
			#{itemUom, jdbcType=VARCHAR},
			TRIM(UPPER(#{workOrderId, jdbcType=VARCHAR})),
			#{demandId, jdbcType=VARCHAR},
			#{netDemandId, jdbcType=VARCHAR},
			#{workSeq, jdbcType=INTEGER},
			#{customerLineCd, jdbcType=VARCHAR},
			#{customerModel, jdbcType=VARCHAR},
			TO_DATE(#{outputTime, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
			TO_DATE(#{dueDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
			<!-- 2018.12-31 hyjeong begin -->
			,#{attr1, jdbcType=VARCHAR}
			<!-- 2018.12-31 hyjeong end -->
		   <if test="value != null and value != ''">
		    ${value}
		   </if>
			)

</insert>
	
<insert id="create_planningUploadProc" statementType="CALLABLE" parameterType="java.util.HashMap">
	{
        CALL SP_RCCP_PROCESS.sync_main (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{planId, mode=IN, jdbcType=VARCHAR}
           , #{createBy, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>

<select id="get_maxPlanDate_list" resultType="camelMap" parameterType="java.util.HashMap">
	SELECT MAX(TO_CHAR(PLAN_START_DTTM, 'YYYY-MM-DD')) AS PLAN_DATE
	FROM TH_MST_PLAN
	WHERE MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
</select>

<delete id="remove_planningUpload" parameterType="java.util.HashMap">
	DELETE FROM TH_BUFMOM_PRODUCTIONPLANDETAIL
	WHERE MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
</delete>

	
   
</mapper>