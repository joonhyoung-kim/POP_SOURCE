<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.plan.psi">
	<select id="get_psi_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT FLOOR((ROWNUM - 1) / 6) + 1 RNUM
		     , ROWNUM JQGRIDROW
		     , A.*
		  FROM (SELECT A.*
		          FROM (SELECT *
		                  from (SELECT A.MASTER_ID
		                             , A.PLAN_ID
		                             , A.ITEM_ID 
		                             , A.SEQ
		                             , A.CATEGORY  
		                             , TO_CHAR(A.PLAN_DATE , 'yyyymmdd') PLAN_DATE
		                             , SUM(A.QTY) AS QTY
		                             , MIN(A.ITEM_GROUP_CODE) AS ITEM_GROUP_CODE 
		                             , MIN(A.ITEM_TYPE) AS ITEM_TYPE  
		                             , MIN((SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, 'ITEM_TYPE', A.ITEM_TYPE)
		                                          FROM DUAL)) AS ITEM_TYPE_NAME
		                             , MIN(DECODE(A.SEQ, 1, (A.TOTAL_QTY), 2, NVL(A.STOCK_QTY,0), NVL(A.PAST_QTY, 0) )) AS QTY_TYPE
	                                 , MIN(DECODE(A.SEQ, 1, A.ITEM_GROUP_LARGE, 2, A.ITEM_GROUP_MEDIUM, A.ITEM_GROUP_SMALL) ) AS ITEM_GROUP
	                                 , MIN(DECODE(A.SEQ, 1,  MOM_COMMON_PKG.FN_GET_CODE_NAME( A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, 'ITEM_GROUP_LARGE', A.ITEM_GROUP_LARGE)
	                                                   , 2,  MOM_COMMON_PKG.FN_GET_CODE_NAME( A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, 'ITEM_GROUP_MEDIUM', A.ITEM_GROUP_MEDIUM)
	                                                   , MOM_COMMON_PKG.FN_GET_CODE_NAME( A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, 'ITEM_GROUP_SMALL', A.ITEM_GROUP_SMALL)) ) AS ITEM_GROUP_NAME
		                          FROM TH_EXP_ORDER_PSI A
		                              , TH_MST_PLAN B
		                         WHERE A.MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
		                           AND A.PLAN_ID = #{planId, jdbcType=VARCHAR}
		                           AND A.MASTER_ID = B.MASTER_ID
                                   AND A.PLAN_ID = B.PLAN_ID
		                          <if test = "itemId != null and itemId != ''">
                                   AND A.ITEM_ID LIKE '%' || TRIM(UPPER(#{itemId, jdbcType=VARCHAR})) || '%'
                                  </if>
                                  <if test = "model != null and model != ''">
                                   AND A.ITEM_GROUP_CODE = #{model, jdbcType=VARCHAR}
                                  </if>
                                  <if test = "itemType != null and itemType != ''">
                                   AND ITEM_TYPE = #{itemType, jdbcType=VARCHAR}
                                  </if>
		                          <if test = "itemGroupLarge != null and itemGroupLarge != ''">
                                   AND A.ITEM_GROUP_LARGE = #{itemGroupLarge, jdbcType=VARCHAR}
                                  </if>
                                  <if test = "itemGroupMedium != null and itemGroupMedium != ''">
                                   AND A.ITEM_GROUP_MEDIUM = #{itemGroupMedium, jdbcType=VARCHAR}
                                  </if>
                                  <if test = "itemGroupSmall != null and itemGroupSmall != ''">
                                   AND A.ITEM_GROUP_SMALL = #{itemGroupSmall, jdbcType=VARCHAR}
                                  </if>
		                           AND A.PLAN_DATE >= TO_DATE(SUBSTR(TO_CHAR(#{planId, jdbcType=VARCHAR}),0,8), 'YYYY-MM-DD')
		                           AND A.PLAN_DATE &lt;= TO_DATE(SUBSTR(TO_CHAR(#{planId, jdbcType=VARCHAR}),0,8), 'YYYY-MM-DD') + B.PLAN_HORIZON
		                          <if test = "shortage != null and shortage != ''">
	                                 <if test = "shortage == 'Y_MINUS'">
	                                 AND ITEM_ID IN (SELECT ITEM_ID 
	                                 				 FROM   TH_EXP_ORDER_PSI
				                                     WHERE  SEQ ='3'
				                                     AND 	QTY &lt; 0
				                                     AND    MASTER_ID = A.MASTER_ID
				                                     AND    PLAN_ID = A.PLAN_ID)
	                                 </if>
                                 </if>
		                         GROUP BY A.MASTER_ID , A.PLAN_ID , A.ITEM_ID , A.SEQ , A.CATEGORY , TO_CHAR(A.PLAN_DATE , 'yyyymmdd')) 
		                         <if test = "pivot != null and pivot != ''">
		                         PIVOT(SUM(QTY) FOR PLAN_DATE IN(${pivot}))
		                         </if>
		                          ) A
		         ORDER BY A.ITEM_ID, A.SEQ) A 
	</select>
	
	<!-- 계획유형 조회 -->
	<select id="get_planType_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT PLAN_TYPE AS NAME, PLAN_ID AS CODE
		FROM   TH_MST_PLAN  A 
		WHERE  MASTER_ID = #{divisionCd, jdbcType=VARCHAR}   
		AND    PLAN_ID LIKE REPLACE(TO_CHAR(MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR} ), 'YYYY-MM-DD'),'-','') || '%'
		ORDER BY NAME DESC
	</select>
	
	<insert id="create_psiCreate" statementType="CALLABLE">
	{
        CALL P_CREATE_ORDER_PSI(
         #{p_err_code, mode=OUT, jdbcType=VARCHAR}
        ,#{p_err_msg, mode=OUT, jdbcType=VARCHAR}
        ,#{divisionCd, mode=IN, jdbcType=VARCHAR}
        ,#{planId, mode=IN, jdbcType=VARCHAR})
    }
    
    </insert>
	
   
</mapper>