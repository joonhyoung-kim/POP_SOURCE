<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.plan.productionPlanNew">
     <select id="get_productionPlan_list" resultType="camelMap" parameterType="java.util.HashMap">
     WITH TEMP1 AS (
		SELECT  A.RESOURCE_ID
                 ,  MIN(R.RESOURCE_NAME)  AS RESOURCE_NAME
                 ,  A.ITEM_ID
                 ,  MIN(I.ITEM_NAME) AS ITEM_NAME
                 ,  MIN(I.SPECIFICATION) AS SPECIFICATION
                 ,  SUM(NVL(MIS.QTY,0)) AS QTY
                 <if test="pivot != '' and pivot != null">
                    ${pivot}
                 </if>
            FROM    TH_EXP_PRODUCTIONPLANDETAIL A
                 ,  MOM_ITEM_DEFINITION I
                 ,  MOM_RESOURCE R
                 , (SELECT ITEM_ID
                         , SUM(CURRENT_QTY) AS QTY 
                      FROM MOM_ITEM_STOCK A
                     WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
                       AND LOCATION_CD IN (SELECT FACILITY_CD 
                                             FROM MOM_FACILITY 
                                            WHERE DIVISION_CD = A.DIVISION_CD 
                                              AND COMPANY_CD = A.COMPANY_CD 
                                              AND FACILITY_CD = A.LOCATION_CD 
                                              AND FACILITY_TYPE = 'FAC400'
                                              AND USE_YN = 'Y')
                     GROUP BY ITEM_ID
                   ) MIS
            WHERE   A.MASTER_ID  = I.DIVISION_CD
            AND     A.ITEM_ID    = I.ITEM_ID  
            AND     A.MASTER_ID  = R.DIVISION_CD
            AND     A.RESOURCE_ID = R.RESOURCE_CD 
            AND     A.ITEM_ID   = MIS.ITEM_ID(+)
            AND     A.MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
            AND     A.PLAN_ID   = #{planId, jdbcType=VARCHAR}
            AND	    A.PLAN_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')  
            <if test="itemId != null and itemId != '' ">
		 	AND    UPPER(A.ITEM_ID || '@' || I.ITEM_NAME) LIKE '%' || TRIM(UPPER(#{itemId, jdbcType=VARCHAR})) || '%'
	       </if>
		   <if test="resourceId != null and resourceId != '' ">
			AND    A.RESOURCE_ID = #{resourceId, jdbcType=VARCHAR}
		   </if>
            GROUP BY A.RESOURCE_ID
                   , A.ITEM_ID
            ORDER BY A.RESOURCE_ID
                   , A.ITEM_ID )
	      SELECT A.*
	           , B.ROW_COUNT
	      FROM (SELECT A.*
	                 , ROWNUM GRIDROW
	              FROM TEMP1 A) A
	         , (SELECT COUNT(*) ROW_COUNT
	              FROM TEMP1) B 
	     <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
		  WHERE GRIDROW BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
	     </if>
	</select>
</mapper>