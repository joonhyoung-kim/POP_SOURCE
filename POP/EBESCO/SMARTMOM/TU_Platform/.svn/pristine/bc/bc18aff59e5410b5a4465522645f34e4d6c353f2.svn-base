<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.equipment.opcScenario">
	<select id="get_opcScenario_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT A.OPC_SCENARIO
		     , A.DIVISION_CD
		     , A.COMPANY_CD
		     , A.OPC_ID
		     , B.OPC_NAME
		     , A.PARENT_OPC_SCENARIO
		     , A.ROOT_PARENT_OPC_SCENARIO
		     , A.OPC_SCENARIO_NAME
		     , A.SP_NAME
		     , A.USE_YN
		     , A.CREATE_BY
		     , TO_CHAR(A.CREATE_DATE, 'YYYY-MM-DD hh24:mi:ss') AS CREATE_DATE
		     , A.UPDATE_BY
		     , TO_CHAR(A.UPDATE_DATE, 'YYYY-MM-DD hh24:mi:ss') AS UPDATE_DATE
		  FROM TU_OPC_SCENARIO A
		     , TU_OPC_SERVER B
		 WHERE A.DIVISION_CD = B.DIVISION_CD
		   AND A.COMPANY_CD = B.COMPANY_CD
		   AND A.OPC_ID = B.OPC_ID
		   AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		   <if test="opcScenario != null and opcScenario != ''">
		   AND A.OPC_SCENARIO LIKE '%' || UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR})) || '%'
		   </if>
		   <if test="opcId != null and opcId != ''">
			AND (A.OPC_ID LIKE '%' || UPPER(TRIM(#{opcId, jdbcType=VARCHAR})) || '%'
			 OR UPPER(B.OPC_NAME) LIKE '%' || UPPER(TRIM(#{opcId, jdbcType=VARCHAR})) || '%')
		   </if>
		  ORDER BY A.OPC_SCENARIO		
	</select>

	<insert id="create_opcScenario" statementType="CALLABLE" parameterType="java.util.HashMap">
		{ CALL
		DECLARE
		BEGIN
		
		#{p_err_code, mode=OUT, jdbcType=VARCHAR ,javaType=String} := 'E';

		INSERT INTO TU_OPC_SCENARIO
				( OPC_SCENARIO
				, DIVISION_CD
				, COMPANY_CD
				, OPC_ID
				, PARENT_OPC_SCENARIO
				, ROOT_PARENT_OPC_SCENARIO
				, OPC_SCENARIO_NAME
				, SP_NAME
				, USE_YN
				, CREATE_BY
				, CREATE_DATE
				, UPDATE_BY
				, UPDATE_DATE
					)
		VALUES (
			    UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
			  , #{divisionCd, jdbcType=VARCHAR}
			  , #{companyCd, jdbcType=VARCHAR}
			  , #{opcId, jdbcType=VARCHAR}
			  , #{parentOpcScenario ,jdbcType=VARCHAR}
			  , #{rootParentOpcScenario, jdbcType=VARCHAR}
			  , #{opcScenarioName, jdbcType=VARCHAR}
			  , #{spName, jdbcType=VARCHAR}
			  , UPPER(#{useYn, jdbcType=VARCHAR})
			  , #{createBy, jdbcType=VARCHAR}
			  , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR})
			  , #{updateBy, jdbcType=VARCHAR}
			  , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR})
				);

		INSERT INTO TU_OPC_SCENARIO_HIST
		(
			  LAST_EVENT_SEQ
			  , OPC_SCENARIO
			  , DIVISION_CD
			  , COMPANY_CD
			  , OPC_ID
			  , PARENT_OPC_SCENARIO
			  , ROOT_PARENT_OPC_SCENARIO
			  , OPC_SCENARIO_NAME
			  , SP_NAME
			  <!-- ,ACTIVITY ,PREV_ACTIVITY -->
			  , USE_YN
			  , CREATE_BY
			  , CREATE_DATE
			  , UPDATE_BY
			  , UPDATE_DATE
		)
		SELECT
			   S_ORDER_SEQ.NEXTVAL
			  , OPC_SCENARIO
			  , DIVISION_CD
			  , COMPANY_CD
			  , OPC_ID
			  , PARENT_OPC_SCENARIO
			  , ROOT_PARENT_OPC_SCENARIO
			  , OPC_SCENARIO_NAME
			  , SP_NAME
			  , USE_YN
			  , CREATE_BY
			  , CREATE_DATE
			  , UPDATE_BY
			  , UPDATE_DATE
		 FROM TU_OPC_SCENARIO
	    WHERE OPC_SCENARIO = UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
		  AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		  AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		;
		
		SELECT
			CASE 
				WHEN COUNT(*) = 0 THEN 'E'
				ELSE 'S'
			END
		  INTO #{p_err_code, mode=OUT, jdbcType=VARCHAR, javaType=String}
		  FROM TU_OPC_SCENARIO
	     WHERE OPC_SCENARIO = UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
		   AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		;

		END
		}


	</insert>
	<update id="modify_opcScenario" statementType="CALLABLE" parameterType="java.util.HashMap">
		{ CALL
		DECLARE
		BEGIN
		#{p_err_code, mode=OUT, jdbcType=VARCHAR ,javaType=String} := 'E';

		UPDATE TU_OPC_SCENARIO 
		   SET OPC_ID = #{opcId, jdbcType=VARCHAR}
			 , PARENT_OPC_SCENARIO = #{parentOpcScenario, jdbcType=VARCHAR}
			 , ROOT_PARENT_OPC_SCENARIO = #{rootParentOpcScenario, jdbcType=VARCHAR}
			 , OPC_SCENARIO_NAME = #{opcScenarioName,jdbcType=VARCHAR} 
			 , SP_NAME = #{spName ,jdbcType=VARCHAR}
			 , USE_YN =  UPPER(#{useYn, jdbcType=VARCHAR})
			 , UPDATE_BY = #{updateBy, jdbcType=VARCHAR}
			 , UPDATE_DATE = MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd ,jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR})
		 WHERE OPC_SCENARIO = UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
		   AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		;
		
		INSERT INTO TU_OPC_SCENARIO_HIST
		(
			  LAST_EVENT_SEQ
			, OPC_SCENARIO
			, DIVISION_CD
			, COMPANY_CD
			, OPC_ID
			, PARENT_OPC_SCENARIO
			, ROOT_PARENT_OPC_SCENARIO
			, OPC_SCENARIO_NAME
			, SP_NAME
			, USE_YN
			, CREATE_BY
			, CREATE_DATE
			, UPDATE_BY
			, UPDATE_DATE
		)
		SELECT
			  S_ORDER_SEQ.NEXTVAL
			, OPC_SCENARIO
			, DIVISION_CD
			, COMPANY_CD
			, OPC_ID
			, PARENT_OPC_SCENARIO
			, ROOT_PARENT_OPC_SCENARIO
			, OPC_SCENARIO_NAME
			, SP_NAME
			, USE_YN
			, CREATE_BY
			, CREATE_DATE
			, UPDATE_BY
			, UPDATE_DATE
		 FROM TU_OPC_SCENARIO
		WHERE OPC_SCENARIO = UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
		  AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		  AND COMPANY_CD = #{companyCd ,jdbcType=VARCHAR}
		;
		
		SELECT
			CASE
				WHEN COUNT(*) = 0 THEN 'E'
				ELSE 'S'
			END
		  INTO #{p_err_code, mode=OUT, jdbcType=VARCHAR, javaType=String}
		  FROM TU_OPC_SCENARIO
		 WHERE OPC_SCENARIO = UPPER(TRIM(#{opcScenario, jdbcType=VARCHAR}))
		   AND DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		;
		END
		}
	</update>
	
	<select id="get_opcId_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT OPC_ID AS CODE
			 , OPC_ID || '(' || OPC_NAME || ')' AS NAME
		  FROM TU_OPC_SERVER
		 WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		   AND USE_YN = 'Y'
		 ORDER BY OPC_ID
	</select>
</mapper>