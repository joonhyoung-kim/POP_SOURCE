<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.plan.verificationPlan"> 
	<select id="get_verificationPlan_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT A.PLAN_ID  
		     , A.MASTER_ID
		     , A.PROBLEM_TYPE
		     , A.PROBLEM_REASON
		     , NVL(TO_CHAR(A.PROBLEM_DTTM, 'YYYY-MM-DD'), '-') AS DUE_DATE
		     , TO_CHAR(A.REQUEST_DTTM, 'YYYY-MM-DD') REQUEST_DATE
		     , A.DEMAND_ID
		     , A.ITEM_ID 
		     , B.ITEM_NAME
		     , B.SPECIFICATION
		     , B.ITEM_TYPE
		     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME( B.DIVISION_CD, B.COMPANY_CD, 'ITEM_TYPE', B.ITEM_TYPE) 
		        FROM   DUAL ) AS ITEM_TYPE_NAME    
		     , A.PROBLEM_QTY
		     , A.ORG_DEMAND_QTY
		     , A.PROBLEM_DESCR
		     , A.PROBLEM_ITEM
		     , ( SELECT MOM_COMMON_PKG.FN_GET_ITEM_NAME(A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, A.PROBLEM_ITEM)  
		         FROM   DUAL ) AS PROBLEM_ITEM_NAME
		     , A.PROBLEM_RESOURCE
		     , ( SELECT MOM_COMMON_PKG.FN_GET_RESOURCE_NAME(A.MASTER_ID, #{companyCd, jdbcType=VARCHAR}, A.PROBLEM_RESOURCE)  
		         FROM   DUAL ) AS PROBLEM_RESOURCE_NAME 
		FROM   TH_EXP_PROBLEMREPORT A
		     , MOM_ITEM_DEFINITION B
		WHERE  A.MASTER_ID = B.DIVISION_CD
		AND    A.ITEM_ID   = B.ITEM_ID
		AND    A.MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
        AND    A.PLAN_ID   =  #{planId, jdbcType=VARCHAR} 
	<if test="problemReason != null and problemReason != ''">
		<choose>
			   <when test="problemReason == 'ITEM_MAPPING'">
			   	AND	A.PROBLEM_REASON   =  'NO_ITEM_MAPPING'
			   </when>
			    <when test="problemReason == 'ITEM'">
			   	AND	A.PROBLEM_REASON   =  'NO_ITEM'
			   </when>
			   <when test="problemReason == 'BOM'">
			   	AND	A.PROBLEM_REASON   =  'NO_BOM'
			   </when>
			    <when test="problemReason == 'BOR'">
			   	AND	A.PROBLEM_REASON   =  'NO_BOR'
			   </when>
			    <when test="problemReason == 'SHIFT_SCHEDULE'">
			   	AND	A.PROBLEM_REASON   =  'NO_SHIFT_SCHEDULE'
			   </when>
		   </choose>
	</if>
	<if test="problemType != null and problemType != ''">
		AND    A.PROBLEM_TYPE   =  #{problemType, jdbcType=VARCHAR} 
	</if>
	<if test="itemType != null and itemType != ''">
	    AND    B.ITEM_TYPE  =  #{itemType, jdbcType=VARCHAR} 
	</if>
	<if test="itemName != null and itemName != ''">
	    AND (B.ITEM_ID LIKE '%' || TRIM(UPPER(#{itemName, jdbcType=VARCHAR})) || '%' 
            OR UPPER(B.ITEM_NAME) LIKE '%' || TRIM(UPPER(#{itemName, jdbcType=VARCHAR})) || '%')
    </if>
	    AND    A.DUE_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') 
	                          AND TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') + 23.9997/24
	    AND    B.USE_YN = 'Y'
	    ORDER BY A.REQUEST_DTTM, A.DUE_DATE, A.ITEM_ID, A.PROBLEM_ITEM     
	</select>
	
	<select id="get_planId_list"  resultType="camelMap" parameterType="java.util.HashMap">
		SELECT PLAN_ID, PLAN_ID AS CODE, PLAN_ID AS NAME
  		FROM TH_MST_PLAN
 		WHERE 1 = 1
   		AND MASTER_ID = #{divisionCd, jdbcType=VARCHAR}
 		GROUP BY PLAN_ID
 		ORDER BY PLAN_ID DESC
	</select>

</mapper>