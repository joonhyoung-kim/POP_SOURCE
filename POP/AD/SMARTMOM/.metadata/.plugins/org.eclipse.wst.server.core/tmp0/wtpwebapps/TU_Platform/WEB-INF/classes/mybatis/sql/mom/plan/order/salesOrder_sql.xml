<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.plan.order.salesOrder">
	<select id="get_salesOrder_list" resultType="camelMap" parameterType="java.util.HashMap">
		<!-- 2019.01.21 hyjeong begin -->
		<if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
		WITH TEMP1 AS (	
		</if>
		<!-- 2019.01.21 hyjeong end -->
		SELECT A.DIVISION_CD
		     , A.COMPANY_CD
		     , A.SALES_ORDER_ID
		     , A.VENDOR_CD
		     , A.VENDOR_CD AS CUSTOMER_CD
		     , A.VENDOR_NAME
		     , A.DESTINATION_CD
		     , A.DESTINATION_NAME
		     , A.CUSTOMER_PO_ID
		     , A.CUSTOMER_PO_TYPE
		     , A.CUSTOMER_PO_NO
		     , A.CUSTOMER_LINE_CD
		     , A.SALES_ITEM_ID
		     , A.ITEM_ID
		     , A.ITEM_NAME
		     , TO_CHAR(A.DUE_DATE, 'YYYY-MM-DD') AS DUE_DATE
		     , A.ORDER_QTY
		     , A.SHIP_QTY
		     , A.RETURN_QTY
		     , A.CANCEL_QTY
		     , A.REMAIN_QTY
		     , A.ORDER_STATE
		     , A.ORDER_STATE_NAME
		     , A.REVENUE_FLAG
		     , A.MARKET_CD
		     , A.MARKET_NAME
		     , A.CURRENCY_CD
		     , A.CURRENCY_NAME
		     , A.UNIT_PRICE
		     , A.FOREIGN_UNIT_PRICE
		     , A.FOREIGN_TOTAL_PRICE
		     , A.EXCHANGE_RATE
		     , A.LC_NO
		     , A.ORDER_TYPE
		     , A.ORDER_GUBUN
		     , A.PRE_BUILD_TERM
		     , A.ORIGIN_DUE_DATE
		     , A.PRODUCTION_START_NO
		     , A.PRODUCTION_END_NO
		     , A.SPLIT_PO
		     , A.MIX_GROUP
		     , A.DESCRIPTION
		     , A.REASON_CODE
		     , A.CREATE_USER_NAME
		     , A.CREATE_DATE
		     , A.UPDATE_DATE
		     , A.UPDATE_BY
		     , A.UPDATE_USER_NAME
		     , A.ORG_CODE
		     , A.HS_PART_NO
		     , A.LGE_PART_NO
		  FROM MOM_SALES_ORDER_V A
		 WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
	       AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	      <if test="(fromDate != null and fromDate != '') and (toDate != null and toDate !='')">
		   AND TO_DATE(SUBSTR(A.ORIGIN_DUE_DATE, 0, 10), 'YYYY-MM-DD') BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'YYYY-MM-DD') AND TO_DATE(#{toDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
	      </if>
	      <if test="modelSuffix != null and modelSuffix != ''">
	       AND UPPER(A.SALES_ITEM_ID) LIKE '%' || TRIM(UPPER(#{modelSuffix, jdbcType=VARCHAR})) || '%'
	      </if>
	      <if test="customerName != null and customerName != ''">
	       AND A.VENDOR_CD = #{customerName, jdbcType=VARCHAR}
	      </if>
	      <if test="vendorCd != null and vendorCd != ''">
	       AND A.VENDOR_CD = #{vendorCd, jdbcType=VARCHAR}
	      </if>
	      <if test="customerPo != null and customerPo != ''">
	       AND UPPER(A.CUSTOMER_PO_NO) LIKE '%' || TRIM(UPPER(#{customerPo, jdbcType=VARCHAR})) || '%' 
	      </if>
	      <if test="customerPoNo != null and customerPoNo != ''">
	       AND UPPER(A.CUSTOMER_PO_NO) LIKE '%' || TRIM(UPPER(#{customerPoNo, jdbcType=VARCHAR})) || '%'
	      </if>
	      <if test="itemName != null and itemName != ''">
	       AND (A.ITEM_ID LIKE '%' || TRIM(UPPER(#{itemName, jdbcType=VARCHAR})) || '%'
	       		OR UPPER(A.ITEM_NAME) LIKE '%' || TRIM(UPPER(#{itemName, jdbcType=VARCHAR})) || '%' )
	      </if>
	      <if test="itemId != null and itemId != ''">
	       AND (A.ITEM_ID LIKE '%' || TRIM(UPPER(#{itemId, jdbcType=VARCHAR})) || '%'
                OR UPPER(A.ITEM_NAME) LIKE '%' || TRIM(UPPER(#{itemId, jdbcType=VARCHAR})) || '%' )
	      </if>
	      <if test="destinationName != null and destinationName != ''">
	       AND A.DESTINATION_CD = #{destinationName, jdbcType=VARCHAR}
	      </if>
	      <if test="destinationId != null and destinationId != ''">
	       AND A.DESTINATION_CD = #{destinationId, jdbcType=VARCHAR}
	      </if>
	      <if test="customerLine != null and customerLine != ''">
	       AND A.CUSTOMER_LINE_CD = #{customerLine, jdbcType=VARCHAR}
	      </if>
	      <if test="customerLineCd != null and customerLineCd != ''">
	       AND A.CUSTOMER_LINE_CD = #{customerLineCd, jdbcType=VARCHAR}
	      </if>
	      <if test="remainQty == 1">
	       AND A.REMAIN_QTY > 0
	      </if>
	      <if test="remainQty == 2">
	       AND A.REMAIN_QTY = 0
	      </if>
	      <if test="orderState != null and orderState != ''">
	       AND A.ORDER_STATE = #{orderState, jdbcType=VARCHAR}
	      </if>
	      <if test="orderGubun != null and orderGubun != ''">
	       AND A.ORDER_GUBUN = #{orderGubun, jdbcType=VARCHAR}
	      </if>
	      <if test="customerPoId != null and customerPoId != ''">
	       AND UPPER(A.CUSTOMER_PO_ID) LIKE '%' || TRIM(UPPER(#{customerPoId, jdbcType=VARCHAR})) || '%'
	      </if>
	      <if test="organizationCode != null and organizationCode != ''">
	       AND A.ORG_CODE = #{organizationCode, jdbcType=VARCHAR}
	      </if>
		 ORDER BY A.DUE_DATE, A.CUSTOMER_PO_ID
	<!-- 2019.01.21 hyjeong begin -->
	<if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
	)
    SELECT A.*
    		, B.ROW_COUNT
    FROM (SELECT A.*
    		, ROWNUM GRIDROW
              FROM TEMP1 A) A
         , (SELECT COUNT(*) ROW_COUNT
              FROM TEMP1) B 
    WHERE GRIDROW BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
    </if>
    <!-- 2019.01.21 hyjeong end -->
	</select>
	
	<select id="get_comSalesOrder_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT DISTINCT A.CUSTOMER_LINE_CD AS CODE
		     , A.CUSTOMER_LINE_CD AS NAME
		  FROM MOM_SALES_ORDER A
		 WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		   AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		   AND A.CUSTOMER_LINE_CD IS NOT NULL
		 ORDER BY CODE
	</select>

	<select id="get_comSalesItemId_list" resultType="camelMap" parameterType="java.util.HashMap">
		SELECT DISTINCT(PRODUCT_CLASS_ID) as CODE
 		FROM MOM_PRODUCT_CLASS_REL
 		WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
   		AND COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	</select>
	
	<insert id="create_salesOrder" statementType="CALLABLE">
	{
        CALL P_CREATE_SALES_ORDER (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{salesOrderId, mode=IN, jdbcType=VARCHAR}
           , #{customerPoId, mode=IN, jdbcType=VARCHAR}
           , #{customerPoNo, mode=IN, jdbcType=VARCHAR}
           , #{salesItemId, mode=IN, jdbcType=VARCHAR}
           , #{itemId, mode=IN, jdbcType=VARCHAR}
           , #{customerCd, mode=IN, jdbcType=VARCHAR}
           , #{destinationCd, mode=IN, jdbcType=VARCHAR}
           , #{dueDate, mode=IN, jdbcType=VARCHAR}
           , #{marketCd, mode=IN, jdbcType=VARCHAR}
           , #{currencyCd, mode=IN, jdbcType=VARCHAR}
           , #{orderQty, mode=IN, jdbcType=INTEGER}
           , #{description, mode=IN, jdbcType=VARCHAR}
           , #{cancelQty, mode=IN, jdbcType=INTEGER}
           , #{orderGubun, mode=IN, jdbcType=VARCHAR}
           , #{updateBy, mode=IN, jdbcType=VARCHAR}
           , #{hsPartNo, mode=IN, jdbcType=VARCHAR}
           , #{lgePartNo, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
	
	<insert id="create_salesMstCreate" statementType="CALLABLE">
	{
        CALL MOM_B2BI.CREATE_B2BI_PO (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{userId, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
	
	<insert id="create_demandPlanCreate" statementType="CALLABLE">
	{
        CALL SP_TAR_DEMAND (
             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{planDate, mode=IN, jdbcType=VARCHAR}
           , #{userId, mode=IN, jdbcType=VARCHAR}
        )
    }
	</insert>
	
	<insert id="create_orderClose" statementType="CALLABLE">
	{
		CALL SP_MOM_SALES_ORDER_PKG.P_SO_CLOSEING ( 
			 #{p_err_code, mode=OUT, jdbcType=VARCHAR}
           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
           , #{companyCd, mode=IN, jdbcType=VARCHAR}
           , #{salesOrderId, mode=IN, jdbcType=VARCHAR}
           , #{userId, mode=IN, jdbcType=VARCHAR} 
        )
	}
	</insert>
	
	<delete id="remove_salesOrderExUpload" statementType="CALLABLE" parameterType="java.util.HashMap">
		DELETE 
		FROM  MOM_SALES_ORDER_UPLOAD
		WHERE DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		AND   COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	</delete>
	
	<insert id="create_salesOrderExUpload" statementType="CALLABLE">
		INSERT INTO MOM_SALES_ORDER_UPLOAD 
					( DIVISION_CD
					, COMPANY_CD
					, VENDOR_CD
					, CUSTOMER_PO_ID
					, CUSTOMER_PO_NO
					, SALES_ITEM_ID
					, ITEM_ID
					, DUE_DATE
					, ORDER_QTY
					, MARKET_CD
					, CURRENCY_CD
					, DESCRIPTION
					, ORG_CODE
					, CREATE_DATE
					, CREATE_BY
					, UPDATE_DATE
					, UPDATE_BY
					)
					VALUES (
					#{divisionCd, jdbcType=VARCHAR},
					#{companyCd, jdbcType=VARCHAR},
					UPPER(TRIM(#{vendorCd, jdbcType=VARCHAR})),
					#{customerPoId, jdbcType=VARCHAR},
					#{customerPoNo, jdbcType=VARCHAR},
					#{salesItemId, jdbcType=VARCHAR},
					UPPER(TRIM(#{itemId, jdbcType=VARCHAR})),
					TO_DATE(#{dueDate, jdbcType=VARCHAR},'YYYY-MM-DD'),
					#{orderQty, jdbcType=INTEGER},
					#{marketCd, jdbcType=VARCHAR},
					UPPER(TRIM(#{currencyCd, jdbcType=VARCHAR})),
					#{description, jdbcType=VARCHAR},
					#{orgCode, jdbcType=VARCHAR},
					MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR}),
					#{userId, jdbcType=VARCHAR},
					MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{divisionCd, jdbcType=VARCHAR}, #{companyCd, jdbcType=VARCHAR}),
					#{userId, jdbcType=VARCHAR}
					)
	</insert>
	
	<insert id="create_salesOrderExUploadProc" statementType="CALLABLE">
		{
	        CALL SP_MOM_SALES_ORDER_PKG.P_SALES_ORDER_UPLOAD (
	             #{p_err_code, mode=OUT, jdbcType=VARCHAR}
	           , #{p_err_msg, mode=OUT, jdbcType=VARCHAR}
	           , #{divisionCd, mode=IN, jdbcType=VARCHAR}
	           , #{companyCd, mode=IN, jdbcType=VARCHAR}
	           , #{userId, mode=IN, jdbcType=VARCHAR}
	        )
	    }
	</insert>

</mapper>