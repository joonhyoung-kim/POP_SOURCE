<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.eis.lossWorstStatus">
	<select id="get_lossWorstStatus_list" resultType="camelMap" parameterType="java.util.HashMap">
		  SELECT NON_TYPE
		       , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(#{divisionCd, jdbcType=VARCHAR}, 
		       											 #{companyCd, jdbcType=VARCHAR}, 
		       											 'NON_WORK_TYPE', 
		       											 NON_TYPE) 
		       		FROM DUAL) AS NON_TYPE_NAME
			   ${pivot1}
		       , SEQ
		    FROM (SELECT NON_TYPE 
		               , SUM(NON_TIME1) AS NON_TIME1
		               , SUM(NON_TIME2) AS NON_TIME2
		               , DENSE_RANK() OVER(ORDER BY SUM(NON_TIME2) DESC, NON_TYPE) AS SEQ
		            FROM (SELECT A.NON_TYPE
		                       , DECODE(B.W_SEQ, 1, (TO_DATE(A.END_TIME, 'yyyymmddhh24miss') - TO_DATE(A.START_TIME, 'yyyymmddhh24miss')) * 60 * 24, 0) AS NON_TIME1
		                       , DECODE(B.W_SEQ, 2, (TO_DATE(A.END_TIME, 'yyyymmddhh24miss') - TO_DATE(A.START_TIME, 'yyyymmddhh24miss')) * 60 * 24, 0) AS NON_TIME2 
		                       , B.WEEKSTART_DATE
		                    FROM MOM_NON_WORK_DATA A
		                       , MOM_RESOURCE R
		                       , (SELECT WEEKSTART_DATE
		                               , DENSE_RANK() OVER(ORDER BY WEEKSTART_DATE) AS W_SEQ
		                               , MAX(WEEKEND_DATE) AS WEEKEND_DATE
		                            FROM TH_MST_TIME
		                           WHERE WEEKSTART_DATE BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'yyyymmdd') - 13 
		                                                    AND TO_DATE(#{fromDate, jdbcType=VARCHAR}, 'yyyymmdd')
		                           GROUP BY WEEKSTART_DATE
		                      ) B
		                   WHERE A.DIVISION_CD = R.DIVISION_CD
			                 AND A.COMPANY_CD  = R.COMPANY_CD
			                 AND A.RESOURCE_CD = R.RESOURCE_CD
		                     AND A.WORK_DATE BETWEEN B.WEEKSTART_DATE AND B.WEEKEND_DATE
		                     AND A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
		                     AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
		                    <if test="placeCd != null and placeCd != ''">
		                     AND R.PLACE_CD = #{placeCd, jdbcType=VARCHAR}
		                    </if>
		                    <if test="resourceGroupCd != null and resourceGroupCd != ''">
		                     AND R.RESOURCE_GROUP_CD = #{resourceGroupCd, jdbcType=VARCHAR}
		                    </if>
		                 ) 
		           WHERE 1=1
		           GROUP BY NON_TYPE
		         )
		   WHERE SEQ <![CDATA[<=]]> 5
		   ORDER BY SEQ
	</select>
	
</mapper>