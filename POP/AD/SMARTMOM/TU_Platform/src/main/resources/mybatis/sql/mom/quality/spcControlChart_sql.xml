<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.thirautech.mom.quality.spcControlChart">
	<select id="get_spcControlChart_list" resultType="camelMap" parameterType="java.util.HashMap">
		WITH REL_TAB AS (
	    SELECT A.WORK_ORDER_ID 
	         , A.DEFECT_LEVEL
	         , A.ITEM_ID
	         , C.ITEM_NAME
    		 , C.SPECIFICATION
	         , A.DEFECT_QTY
	         , A.TARGET
	         , A.USL
	         , A.LSL
	         , A.MEASURE_METHOD
	         , A.GAUGE_METHOD
	         , A.CHECK_METHOD
	         , TO_CHAR(A.STATE_TIME, 'yyyy-mm-dd') AS STATE_TIME
	         , A.PRODUCT_QTY
	         , A.ITEM_VALUE1
	         , A.ITEM_VALUE2
	         , A.ITEM_VALUE3
	         , A.ITEM_VALUE4
	         , A.ITEM_VALUE5
	         , B.SAMPLE_CNT
	         , A.JUDGMENT_ID
         	 , A.DEFECT_BY
	         , CASE WHEN B.SAMPLE_CNT = 1 THEN A.ITEM_VALUE1 / B.SAMPLE_CNT
	                WHEN B.SAMPLE_CNT = 2 THEN (A.ITEM_VALUE1 + A.ITEM_VALUE2) / B.SAMPLE_CNT
	                WHEN B.SAMPLE_CNT = 3 THEN (A.ITEM_VALUE1 + A.ITEM_VALUE2 + A.ITEM_VALUE3) / B.SAMPLE_CNT
	                WHEN B.SAMPLE_CNT = 4 THEN (A.ITEM_VALUE1 + A.ITEM_VALUE2 + A.ITEM_VALUE3 + A.ITEM_VALUE4) / B.SAMPLE_CNT
	                WHEN B.SAMPLE_CNT = 5 THEN (A.ITEM_VALUE1 + A.ITEM_VALUE2 + A.ITEM_VALUE3 + A.ITEM_VALUE4 + A.ITEM_VALUE5) / B.SAMPLE_CNT
	            END AS XBAR
	         , CASE WHEN B.SAMPLE_CNT = 1 THEN A.ITEM_VALUE1
	                WHEN B.SAMPLE_CNT = 2 THEN GREATEST(A.ITEM_VALUE1, A.ITEM_VALUE2)
	                WHEN B.SAMPLE_CNT = 3 THEN GREATEST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3) 
	                WHEN B.SAMPLE_CNT = 4 THEN GREATEST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3, A.ITEM_VALUE4) 
	                WHEN B.SAMPLE_CNT = 5 THEN GREATEST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3, A.ITEM_VALUE4, A.ITEM_VALUE5) 
	            END AS MAX_VALUE
	         , CASE WHEN B.SAMPLE_CNT = 1 THEN A.ITEM_VALUE1
	                WHEN B.SAMPLE_CNT = 2 THEN LEAST(A.ITEM_VALUE1, A.ITEM_VALUE2)
	                WHEN B.SAMPLE_CNT = 3 THEN LEAST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3) 
	                WHEN B.SAMPLE_CNT = 4 THEN LEAST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3, A.ITEM_VALUE4) 
	                WHEN B.SAMPLE_CNT = 5 THEN LEAST(A.ITEM_VALUE1, A.ITEM_VALUE2, A.ITEM_VALUE3, A.ITEM_VALUE4, A.ITEM_VALUE5) 
	            END AS MIN_VALUE
	    FROM MOM_DEFECT_RESULT A
	       , MOM_MEASURE_SPEC B
	       , MOM_ITEM_DEFINITION C
	   WHERE A.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
	     AND A.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	     AND A.MEASURE_METHOD = 'NUMBERLESS'
	     AND A.DEFECT_STATE = 'FINISH'
	     AND A.MEASURE_TYPE = 'PQC'
	     AND A.DIVISION_CD = B.DIVISION_CD(+)
	     AND A.COMPANY_CD = B.COMPANY_CD(+)
	     AND A.DIVISION_CD = C.DIVISION_CD(+)
	     AND A.COMPANY_CD = C.COMPANY_CD(+)
	     AND A.ITEM_ID = B.ITEM_ID(+)
	     AND A.ITEM_ID = C.ITEM_ID(+)
	     AND A.MEASURE_TYPE = B.MEASURE_TYPE(+)
	     AND A.MEASURE_METHOD = B.MEASURE_METHOD(+)
	     AND A.GAUGE_METHOD = B.GAUGE_METHOD(+)
	     AND A.CHECK_METHOD = B.CHECK_METHOD(+)
	     AND A.STATE_TIME BETWEEN TO_DATE(#{fromDate, jdbcType=VARCHAR},'yyyy-mm-dd') AND TO_DATE(#{toDate, jdbcType=VARCHAR},'yyyy-mm-dd') + 23.9997/24
	     AND A.ITEM_ID = #{itemName, jdbcType=VARCHAR}
	     AND A.GAUGE_METHOD = #{gaugeMethod, jdbcType=VARCHAR}
	     AND A.JUDGMENT_ID = 'Y'
	     <if test='defectData == "N"'>
	     AND A.TARGET != 0
	     </if>
	   GROUP BY A.WORK_ORDER_ID
	          , A.ITEM_ID
	          , C.ITEM_NAME
	          , C.SPECIFICATION
	          , A.GAUGE_METHOD
	          , A.CHECK_METHOD
	          , A.DEFECT_LEVEL
	          , A.DEFECT_QTY
	          , A.TARGET
	          , A.USL
	          , A.LSL
	          , A.STATE_TIME
	          , A.PRODUCT_QTY
	          , A.ITEM_VALUE1
	          , A.ITEM_VALUE2
	          , A.ITEM_VALUE3
	          , A.ITEM_VALUE4
	          , A.ITEM_VALUE5
	          , B.SAMPLE_CNT
	          , A.JUDGMENT_ID
         	  , A.DEFECT_BY
         	  , A.MEASURE_METHOD
	)
	, REL_TAB2 AS 
	   (SELECT A.WORK_ORDER_ID 
	         , A.DEFECT_LEVEL
	         , A.ITEM_ID
	         , A.ITEM_NAME
	         , A.SPECIFICATION
	         , A.DEFECT_QTY
	         , A.TARGET
	         , A.USL
	         , A.LSL
	         , A.GAUGE_METHOD
	         , A.CHECK_METHOD
	         , A.STATE_TIME
	         , A.PRODUCT_QTY
	         , A.ITEM_VALUE1
	         , A.ITEM_VALUE2
	         , A.ITEM_VALUE3
	         , A.ITEM_VALUE4
	         , A.ITEM_VALUE5
	         , A.SAMPLE_CNT
	         , A.XBAR
	         , DECODE(A.SAMPLE_CNT, 1, A.ITEM_VALUE1, (A.MAX_VALUE - A.MIN_VALUE)) AS R_RANGE
	         , A.JUDGMENT_ID
         	 , A.DEFECT_BY
	      FROM REL_TAB A
	   )
	SELECT A.WORK_ORDER_ID 
	     , A.DEFECT_LEVEL
	     , A.ITEM_ID
	     , A.ITEM_NAME
	     , A.SPECIFICATION
	     , A.DEFECT_QTY
	     , A.TARGET
	     , A.USL
	     , A.LSL
	     , A.GAUGE_METHOD
	     , A.CHECK_METHOD
	     , A.STATE_TIME
	     , A.PRODUCT_QTY
	     , A.ITEM_VALUE1
	     , A.ITEM_VALUE2
	     , A.ITEM_VALUE3
	     , A.ITEM_VALUE4
	     , A.ITEM_VALUE5
	     , A.SAMPLE_CNT
	     , A.XBAR
	     , A.R_RANGE
	     , B.XBAR_CL
	     , B.XBAR_UCL
	     , B.XBAR_LCL
	     , B.XBAR_MIN
	     , B.R_RANGE_CL
	     , B.R_RANGE_UCL
	     , B.R_RANGE_LCL
	     , B.R_RANGE_MIN
	     , A.JUDGMENT_ID
         , A.DEFECT_BY
	 FROM REL_TAB2 A
	    , (SELECT AVG(XBAR) AS XBAR_CL
	            , AVG(XBAR) + (MAX(MC.ATTRIBUTE1) * AVG(R_RANGE)) AS XBAR_UCL
	            , AVG(XBAR) - (MAX(MC.ATTRIBUTE1) * AVG(R_RANGE)) AS XBAR_LCL
	            , MIN(XBAR) AS XBAR_MIN
	            , AVG(R_RANGE) AS R_RANGE_CL
	            , MAX(MC.ATTRIBUTE3) * AVG(R_RANGE) AS R_RANGE_UCL
	            , MAX(MC.ATTRIBUTE2) * AVG(R_RANGE) AS R_RANGE_LCL
	            , MIN(R_RANGE) AS R_RANGE_MIN
	         FROM REL_TAB2 R2
	            , MOM_CODE MC
	        WHERE MC.DIVISION_CD = #{divisionCd, jdbcType=VARCHAR}
	          AND MC.COMPANY_CD = #{companyCd, jdbcType=VARCHAR}
	          AND MC.CODE_CLASS_ID = 'XBAR_R_MGT'
	          AND MC.CODE_ID = R2.SAMPLE_CNT
	          AND MC.USE_YN = 'Y'
	      ) B
	ORDER BY A.WORK_ORDER_ID, A.ITEM_ID, A.GAUGE_METHOD, A.CHECK_METHOD, A.DEFECT_LEVEL
	</select>

</mapper>